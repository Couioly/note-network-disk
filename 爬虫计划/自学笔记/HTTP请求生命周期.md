
HTTP请求的生命周期：**指从用户在浏览器中输入URL开始，到页面完全加载并显示出来为止，中间发生的所有步骤**。大体分为两大阶段：

- **前端阶段**：发生在客户端（通常为浏览器）和应用基础设施上的操作
- **后端阶段**：发生在服务器端，涉及应用程序逻辑、数据库等

---

## 前端阶段

### Step1 URL 解析

**目标**：用户在浏览器地址栏输入 `https://www.example.com/page` 并按下回车。

**处理过程**：浏览器对输入的URL进行解析，判断是否合法：

- **不合法**：浏览器会使用默认的搜索引擎进行搜索（例如搜索URL为某个关键字）；
- **合法**：浏览器对URL进行解析以划分出协议、主机名、端口、路径等信息。

```url
以https://www.example.com/page为例：
解析后的信息为：
协议：https
主机名：www.example.com
端口：不指定时使用默认值443/80（https默认443，http默认80）
路径：/page
```

### Step2 DNS 查询

**目标**：将人类可读的主机名（域名）转换为计算机可读的IP地址。

**处理过程**：进行一个递归查询：

- **浏览器缓存**：浏览器首先检查自己的缓存中是否存有这个域名的IP地址；
- **操作系统缓存**：若浏览器缓存不存在，则它将查询操作系统的**hosts文件**和**DNS解析器**缓存；
- **路由器缓存**：查询本地网络的路由器；
- **ISP DNS服务器**：若以上查询都不存在该IP，请求会发送至互联网服务提供商（ISP）的DNS服务器（ISP的DNS递归解析器），这是最常见的查询起点；
- **递归查询**：ISP的DNS服务器会从DNS根域名服务器开始，依次查询顶级域（TLD）服务器，最后查询权威名称服务器，获取到最终的IP地址；一旦找到IP，它将被缓存起来，以备后续使用。

>[!tips] 用自己的话说
>所以说，浏览器（客户端）只是发布了一个**递归查询**指定域名IP的任务，要求获得结果，倘若通过**浏览器、操作系统和路由器的缓存查询**后仍未找到该域名的IP，会将“递归查询”的任务委托给**ISP的DNS递归解析器**，ISP的DNS递归解析器将在全球DNS系统中按照“根域名服务器->顶级域服务器->权威名称服务器”的顺序进行**迭代查询**，最终返回结果！

>[!faq] 浏览器的IP存储我们是否可以查询到？
>以Chorme浏览器为例：
>- `chrome://net-internals/#dns`：该内部页面可以查询浏览器缓存的IP地址，你可以手动点击 `Clear host cache` 来清空它；
>- `chrome://settings/clearBrowserData`：可以快速跳转到清除浏览数据的设置页面。

### Step3 建立TCP连接

**目标**：在客户端和服务器之间建立一个可靠的连接通道，因为HTTP是基于TCP的。

**过程处理**：通过TCP的**三次握手**：

1. **第一次握手（SYN：Synchronize Sequence Numbers）**：
	- **客户端** 发送一个TCP数据包，数据包内容包含：
		- **SYN（同步序列号）标志位设置为1**
		- 一个客户端的**初始序列号（ISN）**
	- **辅助理解**：客户端对服务器说：“你好！我想和你建立连接。我的初始序列号是X，你听到了吗？”

2. **第二次握手（SYN-ACK）**：
	- **服务端** 收到SYN包后，会回复一个TCP数据包，数据包包含：
		- **同时设置的两个标志位：SYN=1 和 ACK=1**
		- 服务端自己的**初始序列号（ISN）**
		- **确认号（ACK number）**，其值为 **客户端的初始序列号 + 1**
	- **辅助理解**：服务端对客户端说：“我收到了你的连接请求（ACK你的SYN）！我同意建立连接。我的初始序列号是Y，你听到了吗？”

3. **第三次握手（ACK：Acknowledgment，确认）**：
	- **客户端** 收到SYN-ACK包后，会再发送一个TCP数据包，数据包包含：
		-  **ACK标志位设置为1**
		- **确认号（ACK number）**，其值为 **服务端的初始序列号 + 1**
	- **辅助理解**：客户端对服务端说：“好的，我收到了你的同意信号（ACK你的SYN）！现在我们都可以确认连接是双向畅通的了，可以开始传输数据了。”

经过这三个步骤，一个稳定、可靠的TCP连接才正式建立，随后才会进行TLS握手（如果是HTTPS）和HTTP数据的传输。

>[!faq] 为什么需要三次握手？
>- 防止已失效的连接请求突然传到服务器，导致错误或资源浪费；
>- 第三次握手时客户端对服务器连接意愿的最终确认。

### Step4 建立TLS连接

**目标**：倘若客户端发送的是HTTPS，在TCP连接之上还需要建立一个安全的**加密通道**。

**过程**：通过 **TLS 握手** 完成：

- **ClientHello**：客户端向服务器发送支持的TLS版本、加密套件列表等信息。
- **ServerHello**：服务器选择TLS版本和加密套件，并发送其SSL证书（包含公钥）。
- **验证证书**：客户端验证服务器证书的合法性（是否由可信机构颁发，是否过期，域名是否匹配等）。
- **密钥交换**：客户端生成一个“预主密钥”，用服务器的公钥加密后发送给服务器。服务器用自己的私钥解密。双方利用这个预主密钥生成相同的会话密钥。
- **加密通信**：握手完成，后续所有的HTTP数据都将使用这个会话密钥进行加密传输。

>[!faq] SSL证书是什么？
>通俗的讲，**SSL证书就是一个数字“身份证”**。是由一个受信任的第三方机构（称为**证书颁发机构，CA**）向网站服务器颁发SSL证书，来证明 **网站的真实性和连接的加密性**。
>它的两个核心作用是：
>1. **身份认证**：向访客证明该网站是真实的，而非钓鱼网站。
>2. **启用加密**：使得浏览器和服务器之间能够建立安全的、加密的TLS连接，防止通信被窃听或篡改。
>
>当你的浏览器访问一个HTTPS网站时，它会首先向服务器索要这个“身份证”（证书）进行验证。验证通过后，才会进行后续的密钥交换和加密通信。

>[!faq] TLS是什么？
>**TLS（传输层安全协议）** 是一种**加密协议**，旨在为计算机网络通信提供安全性和数据完整性。
>它的核心目标是：**在两个通信应用程序（如浏览器和Web服务器）之间建立一个安全的通道，防止窃听、篡改和消息伪造。**

>[!note] TLS与SSL的关系
>TLS是SSL（安全套接字层）协议的继任者。由于SSL存在已知的安全漏洞，它已被完全弃用。现在我们常说的“SSL证书”或“SSL加密”，实际上指的都是**TLS**。这个术语由于历史原因被保留了下来，但技术本身已经是TLS。

>[!faq] SSL证书包含哪些内容？
>一个SSL证书实际上是一个遵循X.509标准的数字文件，里面包含了明文（可读）信息和加密的签名信息。主要包含以下三大部分：
>
>1. 核心身份信息（明文，任何人都可查看）
>
>	- **主题（Subject）**：证书持有者的信息。
>	- **通用名称（CN）**：这是**最重要的字段**，通常是网站的域名。例如 `www.example.com` 或 `example.com`。对于通配符证书，会是 `*.example.com`。
>	- **组织（O）**：拥有该域名的组织/公司名称。
>	- **组织单位（OU）**：部门名称。
>	- **地理位置**：所在城市（L）、省/州（ST）、国家（C）。
>	- **颁发者（Issuer）**：签发此证书的证书颁发机构（CA）的信息。例如 `DigiCert Inc`, `Let's Encrypt` 等。
>	- **有效期（Validity）**：
>	- **生效日期（Not Before）**
>	- **过期日期（Not After）**：证书在此时间之后失效，浏览器将拒绝过期的证书。
>	- **公钥（Public Key）**：这是证书**最核心的加密部分**。它是一串很长的数字，用于在TLS握手时加密“预主密钥”，并且只有拥有对应**私钥**的服务器才能解密。**公钥可以公开，但私钥必须被服务器绝密保存。**
>	- **序列号（Serial Number）**：由CA分配的唯一编号，用于标识和管理证书。
>
>2. 扩展信息（明文）
>
>	- **主题备用名称（SAN）**：允许一个证书保护多个域名。例如，一个证书可以同时保护 `example.com`, `www.example.com`, `api.example.com`。
>	- **密钥用法（Key Usage）** 和 **扩展密钥用法（Extended Key Usage）**：规定了这个证书/公钥的用途，例如用于TLS服务器认证、代码签名等。
>	- **CRL分发点（CRL Distribution Points）** 和 **权威信息访问（Authority Information Access）**：告诉浏览器如何检查该证书是否已被CA吊销。
>
>3. 数字签名（**加密部分**）：这是证书**防伪**的关键。
>	- **签名算法**：CA签发证书时使用的哈希和加密算法，例如 `SHA256-RSA`。
>	- **数字签名**：CA会对上面所有**明文信息**（主题、颁发者、公钥、有效期等）计算一个哈希值，然后用CA自己的**私钥**对这个哈希值进行加密，加密后的结果就是“数字签名”。

