
**渗透测试流程与标准**

## 1 了解渗透测试
---
### 1.1 什么是渗透测试

渗透测试是一种安全性测试，通过发起模拟**网络攻击**的方式查找计算机系统中的漏洞。
**渗透测试人员是拥有高超道德黑客技术的安全专业人员**（道德黑客是指运用黑客工具和黑客技术来修复安全薄弱环节而不是造成伤害）。**许多企业会雇用渗透测试人员来对其应用程序、网络和其他资产发起模拟攻击。通过发起虚假攻击，渗透测试人员可以帮助安全团队发现严重安全漏洞，改善整体安全状况**。

**术语“道德黑客”和“渗透测试”有时可以互换使用，但存在差异**。**道德黑客**是一个**更广泛**的网络安全领域，包括任何运用黑客技能来改善网络安全的行为。渗透测试只是道德黑客运用的多种方法之一。道德黑客可能还会提供恶意软件分析、风险评估和其他服务。

>[!info] **软件开发流程**
>**确定需求** -> **需求文档的编辑/ 测试文档**（功能） -> **开发人员写代码** -> **测试**（功能）--**渗透测试**(软件公司内部人员测试)--> **项目上线** --> **渗透测试**（软件公司内部人员、社会网安人员）

### 1.2 渗透分类

**黑盒测试**

是指测试人员在**不清楚被测单位内部技术架构的情况下**，从外部对网络设施的安全性进行测试的过程。黑盒测试借助于真实世界的黑客方法、黑客工具，有组织有步骤的对目标系统进行逐步的渗透和入侵，揭示目标系统中一些已知的和未知的安全漏洞，并评估这些漏洞是否可以被不法分子利用，并造成业务和资产损失。

**白盒测试**

**测试人员可以获取被测单位的网络结构和各种底层技术，在此基础上，使用针对性的测试方法和工具**，可以以较小的代价发现和验证系统最严重的安全漏洞 。 两者各有利弊，需结合进行。

**灰盒测试**

**渗透测试人员可以根据对目标系统获取的有限的知识和信息，选择渗透测试的最佳路径，渗透测试者也需要从外部逐渐的渗透进入内部网络，同时，他们所拥有的目标网络底层拓扑结构有助于他更好的选择攻击途径和方法，从而达到更好的渗透测试效果**。

### 1.3 渗透基本概念

**肉鸡**

所谓“肉鸡”是一种很形象的比喻，比喻那些可以被攻击者控制的电脑、手机、服务器或者其他摄像头、路由器等智能设备，用于发动网络攻击。

**木马**

就是那些表面上伪装成了正常的程序，但是当这些程序运行时，就会获取系统的整个控制权限。有很多黑客就是热衷使用木马程序来控制别人的电脑，比如灰鸽子。

**后门**

这是一种形象的比喻，入侵者在利用某些方法成功的控制了目标主机后，可以在对方的系统中植入特定的程序，或者是修改某些设置，用于访问、查看或者控制这台主机。

**弱口令**

指那些强度不够，容易被猜解的，类似 123，abc 这样的口令

**0day 漏洞**

在网络攻防的语境下，0day 漏洞指那些已经被攻击者发现掌握并开始利用，但还没有被包括受影响软件厂商在内的公众所知的漏洞

**1day 漏洞**

指漏洞信息已公开但仍未发布补丁的漏洞。此类漏洞的危害仍然较高，但往往官方会公布部分缓解措施，如关闭部分端口或者服务等。

**Nday 漏洞**

指已经发布官方补丁的漏洞。通常情况下，此类漏洞的防护只需更新补丁即可，但由于多种原因，导致往往存在大量设备漏洞补丁更新不及时，且漏洞利用方式已经在互联网公开，往往此类漏洞是黑客最常使用的漏洞。

**免杀（3阶段）**

电脑中的安全防护软件会对我们电脑下载的或者储存的文件进行扫描，如果发现危险会自行删除，免杀就是通过加壳、加密、修改特征码、加花指令等等技术来修改程序，使其逃过杀毒软件的查杀。

**社工（骗）**

一种无需依托任何黑客软件，更注重研究人性弱点的黑客手法正在兴起，这就是社会工程学黑客技术。 通俗而言是指利用人的社会学弱点实施网络攻击的一整套方法论，其攻击手法往往出人意料。**【非法】社工库：是由许多黑客收录的各大平台泄露的信息或者黑客通过非法手段获取的信息。**

**提权（3阶段）**

指得到你本没得到的权限，比如说电脑中非系统管理员就无法访问一些 C 盘的东西，而系统管理员就可以，通过一定的手段让普通用户提升成为管理员，让其拥有管理员的权限，这就叫提权。

**网络靶场（公网靶场/内网靶场）**

主要是指通过虚拟环境与真实设备相结合，模拟仿真出真实赛博网络空间攻防作战环境，能够支撑攻防演练、安全教育、网络空间作战能力研究和网络武器装备验证试验平台。

### 1.4 渗透核心概念

- **POC：全称 'Proof of Concept'，中文 '概念验证' ，常指一段漏洞证明的代码**
- **EXP：全称 'Exploit'，中文 '利用'，指利用系统漏洞进行攻击的动作**
- **Payload：中文 '有效载荷'，指成功exploit之后，真正在目标系统执行的代码或指令。（木马脚本）**
- **Shellcode：简单翻译 'shell代码'，是Payload的一种，由于其建立正向/反向shell 而得名。（木马脚本）**

## 2 渗透分析流程
---
### 2.1 制定渗透计划

**目标确定：**
- 测试范围：明确哪些系统、网络、应用或特定IP/域名将接受测试。
- 测试账户：如果测试需要特定的访问权限，应事先准备或申请这些账户。
- 测试规则和需求：定义测试的具体目标，如查找web应用的SQL注入漏洞、业务逻辑漏洞等。

**工具与资源：**
- 工具：选择适合的渗透测试工具，如漏洞扫描器、端口扫描器、社会工程学技巧和密码爆破工具等。
- **重点：电脑、服务器、数据库、程序等是渗透测试的主要对象，需要根据测试目标详细规划**。
- **SRC平台**(挖洞)：以下提到的SRC平台（如补天、安恒SRC）是安全漏洞响应中心，SRC平台为白帽子提供了一个合法的渠道来发现和报告漏洞，同时也为企业提供了一个高效的漏洞修复机制。企业可通过这些平台公开征集安全漏洞的发现和修复。虽然这不是渗透测试的直接步骤，但了解这些平台有助于理解漏洞披露的正规渠道。

>[!warning] SRC平台
>补天：https://www.butian.net/Reward/plan/2
>安恒：https://www.anquanke.com/src/

### 2.2 信息收集

渗透测试的信息收集是一个全面而细致的过程，**需要收集各种类型的信息来全面了解目标并发现潜在的安全漏洞**。这些信息将作为后续渗透测试的基础和依据。

>[!tips] 收集方式
>- **主动扫描**：主动发送数据包到目标系统，以探测目标系统的安全漏洞、开放端口、服务状态等信息。需要**与目标系统建立直接的通信连接，并发送特定的数据包来触发目标系统的响应**。
>- **开放搜索**：**利用公开信息或开放资源进行搜索和发现安全漏洞**的方法。这种方法可能包括使用搜索引擎、开放数据库、社交媒体等渠道来收集目标系统的相关信息。

#### 核心基础信息

**IP地址**

**ip是动态绑定某一台电子设备的（不是永远绑定），MAC地址才是永远跟某一台电子设备绑定的**。目标主机的 IP 地址是渗透测试的基石信息。它是网络中标识主机的唯一数字标识，是与目标进行网络通信和后续测试操作的起点。

**网段**

了解目标主机所在的网段，能够**帮助我们掌握目标网络的整体规模和结构布局**。网段划定了一个特定的网络范围，在这个范围内的主机通常具有相似的网络配置和安全策略，**有助于我们从宏观层面规划渗透测试的范围和策略**。

**域名**

目标网站的域名是用户访问网站的常用 URL 地址，也**是信息收集的关键切入点**。通过域名，我们可以进一步挖掘与之相关的各种信息，如子域名、网站架构等。

**子域名（python代码收集）**

**收集子域名能够显著扩大攻击范围**。同一主域名下的二级域名通常属于相同的资产范畴，彼此之间往往存在一定的关联。通过收集子域名，可以发现更多处于渗透测试范围内的域名和子域名，从而**大大增加发现漏洞的概率**。

>[!info] vivo.com子域名的在线查询
>1. 查域名：https://chaziyu.com/vivo.com.cn/
>2. IP138子域名查询：https://site.ip138.com/vivo.com.cn/domain.htm
>3. 站长工具子域名查询：https://tool.chinaz.com/subdomain/vivo.com.cn

#### 端口信息

**端口的重要性**

端口作为服务器与客户端进行交互的关键接口，其作用举足轻重。不同的端口对应着不同的网络服务，通过对目标主机开放端口的扫描，我们可以了解主机上运行的各类程序和中间件，进而发现潜在的服务漏洞。

**端口扫描策略与工具使用 (kali)**

端口扫描是发现目标主机开放端口及对应服务的重要手段。为了高效且准确地完成端口扫描任务，我们可以采用以下工具组合的策略：

1. **Masscan**：这**是 Kali Linux 系统中内置的一款强大端口扫描工具，其性能优于Nmap**。由于 Masscan 的扫描速度极快，我们可以**先使用它对目标 IP（通常是一个网段）进行全端口扫描，快速定位存活主机及其开放端口**。例如，若要扫描某个网段的所有端口，可以使用类似 `masscan -p1-65535 目标网段` 的命令。
2. **Nmap**：在 Masscan 完成初步扫描后，**再使用 Nmap 对存活主机的开放端口进行详细扫描**。**Nmap 能够更精确地识别端口对应的服务，并检测这些服务是否存在已知漏洞**。例如，针对 Masscan 发现的开放端口主机，可使用 `nmap -sV -p开放端口列表 目标IP` 命令进行进一步扫描。

此外，在端口扫描过程中，还可以使用 NC（Netcat）工具，关于其具体使用方法在之前已有介绍。通过合理运用这些工具和策略，我们能够全面且深入地了解目标主机的端口和服务情况，为后续的渗透测试工作提供有力支持。

>[!info] masscan常用扫描参数
>**目标指定**
>- `IP 地址或网段`：可以直接指定单个 IP 地址，如192.168.1.100，也可以使用CIDR 表示法指定网段，如192.168.1.0/24，表示扫描该网段内的所有主机。
>- `-iL`：从文件中读取目标 IP 地址或网段列表。例如`masscan -iL targets.txt`，targets.txt文件中每行是一个 IP 地址或网段。
>- `--exclude IP`：排除特定主机，例如`masscan 0.0.0.0/0 -p 443 --exclude 192.168.1.0/24,10.0.0.0/8`表示排除多个IP或段。
>
>**端口设置**
>- `-p`：指定扫描的端口范围。例如`-p80`表示只扫描 80 端口，`-p1-1024`表示扫描1到1024的所有端口，`-p80,443,8080` 表示扫描 80 、443 和 8080 这三个端口。
>- `--top-ports`：指定扫描最常用的 N 个端口。例如`--top-ports 10`表示扫描最常用的10个端口。
>- `--exclude-ports`：排除指定的端口不扫描。例如`--exclude-ports 22,23`表示不扫描22和23端口。

**动手实操案例**

扫描单个IP：`sudo masscan 192.168.254.153 -p80`

- `sudo`获取管理员权限
- `masscan`是扫描工具
- `192.168.1.100`是目标IP
- `-p80`指定只扫描80端口，用于检测该IP的80端口是否开放

```bash
# 进入管理员模式
sudo su
# 去进行扫描
masscan IP/域名 -p端口
# 举例
masscan 192.168.254.57 -p80
```

![[Pasted image 20251024151225.png]]

**扫描多个IP**：`sudo masscan 192.168.1.100 192.168.1.101 -p80`，此命令可以同时扫描两个IP的80端口，若有更多IP，依次添加并指定端口即可。

**扫描一个IP段**：`sudo masscan 192.168.1.1-254 -p80`， 该命令会扫描此IP段内所有主机的 80 端口，常用于快速查看一个小型局域网内哪些主机的80端口开放。

**使用CIDR表示法进行扫描**：`sudo masscan 192.168.1.0/24 -p80`，/24表示子网掩码为255.255.255.0 ，扫描此网段内所有主机的80端口，适用于对特定网段进行端口扫描。

**从文件中加载目标扫描**：假设targets.txt文件每行存放一个IP地址或IP段，运行`sudo masscan -iL targets.txt -p80`，Masscan会从该文件读取目标并扫描其80端口，适用于批量扫描大量目标。

**排除特定主机扫描**：`sudo masscan 192.168.1.0/24 -p80 --exclude 192.168.1.100`，该命令会扫描网段内除 192.168.1.100 之外所有主机的80端口，用于排除特定主机。

**TCP SYN端口扫描**：Masscan 默认使用类似 TCP SYN 扫描的方式，命令如`sudo masscan 192.168.1.100 -p80`，它通过发送SYN包探测端口，收到SYN/ACK包表示端口开放，再发送RST包断开连接，速度快且相对隐蔽 。

**UDP端口扫描**：`sudo masscan 192.168.1.100 - pU:53`，用于扫描目标主机的
UDP 53 端口，由于 UDP 是无连接协议，扫描难度相对较大，结果可能不够准确。

**快速端口扫描**：`sudo masscan 192.168.1.100 -p80,443,22`，只扫描指定的常用端口，相比全端口扫描，速度更快，适用于快速了解目标主机是否开放了常见服务端口。

**扫描指定端口范围**：`sudo masscan 192.168.1.100 -p1-1024`，此命令会扫描目标主机的 1 到 1024 号端口，可自定义端口范围。

**全端口扫描**：`sudo masscan 192.168.1.100 -p0-65535`，扫描目标主机的所有65535个端口，耗时较长，但能全面了解端口开放情况。

**扫描前 N 个热门端口**：`sudo masscan 192.168.1.100 --top-ports 2000`，扫描目标主机最常使用的 2000 个端口，可快速获取较多常见服务端口信息。

>[!info] nmap语法介绍

`nmap 目标 IP`：**对目标IP地址展开基本的网络扫描**操作，能**初步探测出目标主机开放的端口**，知晓哪些网络服务可能正在对外提供服务，如`nmap 192.168.1.100`

```bash
# 进入管理员模式
sudo su
# 进行扫描
nmap IP/域名
# 举例
nmap www.baidu.com
```

![[Pasted image 20251024153936.png]]

`nmap -sS 目标 IP`：**运用 SYN 扫描方式对目标 IP 地址实施端口扫描**。这种扫描方式较为隐蔽，通过发送 SYN 包模拟 TCP 连接建立过程的三步握手，能快速且相对隐蔽地探测端口开放情况，例如`nmap -sS 192.168.1.100`

![[Pasted image 20251024154256.png]]

`nmap - sV 目标IP`：**着重扫描目标IP地址上运行服务的版本信息**，对于安全评估至关重要，能**帮助识别潜在的漏洞风险**，依据版本信息针对性地采取防护措施，如`nmap -sV 192.168.1.100`

![[Pasted image 20251024154603.png]]

#### 操作系统信息收集

**识别操作系统的方法与意义**

通过**向目标主机发送特定的探测包**，然后仔细**分析响应包中的相关信息**，我们**能够推出目标主机所使用的操作系统类型及其版本**。准确识别操作系统对于后续制定漏洞利用方案和攻击策略起着至关重要的作用，因为**不同的操作系统可能存在不同的安全漏洞和防护机制**。

**收集方法**

1. **TTL值分析（初步判断）**

**原理**：不同操作系统的默认TTL（Time-To-Live）值不同。
Linux：TTL ≈ 64
Windows：TTL ≈ 128
命令：`ping IP/域名`

输出示例：`64 bytes from example.com: icmp_seq=1 ttl=64 time=25.4ms`
若`TTL≈53`（初始64-跳数），可能为Linux；`TTL≈115`（初始128-跳数），可能为
Windows。

>[!warning] 注意
>大型网站可能修改默认TTL

2. **Nmap OS探测**

**原理**：通过TCP/IP堆栈指纹识别操作系统。
命令：`nmap - O <目标IP>`

输出示例：
```
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3.2
```

#### 中间件信息收集

**中间件概述**

**中间件是位于应用程序和操作系统之间的软件，常见的有Web服务器**（如Apache、Nginx等）以及**应用服务器**（如Tomcat、JBoss等）。

**收集的重要性**

**收集中间件信息有助于我们全面了解目标网站的技术架构**。基于对中间件的了解，我们**可以进一步发现可能存在的中间件漏洞**，为后续的渗透测试提供方向。

#### 脚本语言信息识别

**识别脚本语言的途径**

通过深入分析网页源代码、HTTP 响应头等信息，我们可以识别出目标网站所使用的脚本语言，例如 JavaScript、PHP、ASP.NET 等。

**识别的作用**

**了解网站使用的脚本语言有助于我们知晓网站的功能实现方式**。同时，不同的脚本语言可能存在各自特有的安全漏洞，**识别脚本语言能够帮助我们有针对性地进行安全漏洞排查**。

**常见Web脚本语言及特征**

![[Pasted image 20251024160215.png]]

**可用方法总结**

![[Pasted image 20251024160421.png]]

#### 数据库信息收集

**收集内容**

主要是了解目标网站所使用的**数据库类型**（如 MySQL、SQL Server、Oracle 等）以及对应的**版本信息**。

**收集的意义**

掌握数据库类型和版本信息后，我们**可以更有针对性地进行数据库漏洞扫描和渗透测试**，因为不同类型和版本的数据库存在的安全风险可能不同。

**常见数据库类型及默认特征**

![[Pasted image 20251024160717.png]]

**数据库信息收集方法**

1. **通过Web应用获取**

- **报错信息泄露**。执行`' AND 1=CONVERT(int, @@version)--`语句触发SQL错误，观察返回信息：

```
MySQL 报错可能包含 "You have an error in your SQL syntax; check the manual..."
SQL Server 可能返回 "Conversion failed when converting..."
```

- **默认管理界面**

```
MySQL：/phpmyadmin/、/adminer.php
SQL Server：/sqlmanager/、/aspnet_client/
MongoDB：/mongoadmin/、/rockmongo/
```

2. **通过端口扫描**

使用 Nmap 探测数据库开放端口

```bash
nmap - p 3306,1433,1521,5432,27017 <目标IP>
```

示例输出：

```
3306/tcp open mysql
1433/tcp open ms-sql-s
```

#### CMS 源码分析

**适用情况**

如果**目标网站采用了内容管理系统**（CMS），像 WordPress、Joomla 等，就**需要对其进行相关分析**：

>[!tips] 内容管理系统（CMS，Content Management System）
>是一种用于创建、编辑、管理和发布数字内容的软件平台。它允许用户（即使没有编程知识）轻松管理网站内容，如文章、图片、视频等，而无需手动编写代码。
>1. WordPress
>- 全球最流行的 CMS（占全网 43% 的网站），适合博客、企业站、电商
>- 特点：海量主题/插件、易用性强
>1. Joomla
>- 灵活性高，适合中大型网站，但学习曲线较陡

**分析内容与目的**

收集CMS的源码信息（**大多数 CMS，如 WordPress 、Joomla 等都是开源的，可以直接从官网下载对应版本**），分析其版本以及插件的使用情况。这样做有助于我们发现CMS本身或者其插件存在的已知漏洞，进而开展针对性的渗透测试。

#### 社工(社会工程学)信息收集

**联系人信息**

收集目标网站的管理员、开发人员或其他关键人员的联系方式，如邮箱、电话等。这些信息在社会工程学攻击中可能会发挥重要作用，攻击者可以通过伪装身份利用这些联系方式获取更多敏感信息。

**人员信息**

了解目标公司或组织的人员结构、职责分工等情况。通过分析人员信息，我们能够找出潜在的安全弱点，从而制定更合适的渗透测试策略。

**公司信息**

收集目标公司的业务范围、组织架构、企业文化等方面的信息。从宏观层面了解目标公司，有助于我们发现与公司业务相关的安全漏洞，为渗透测试提供更全面的视角。

**域名/服务器注册商信息**

查询目标域名的注册信息以及服务器提供商的相关信息。这些信息可以让我们了解域名的注册人、注册时间、到期时间，还能知晓服务器的物理位置和安全防护措施等内容，为渗透测试提供更多的背景信息。

### 2.3 漏洞探测

**基于收集到的信息，使用自动化或手动的方式对目标进行漏洞扫描，查找可能的安全漏洞。**

#### 工具扫描

使用漏洞扫描工具（如SQLMAP、Nessus、Acunetix等）结合漏洞库（如 www.exploit-db.com ）对目标系统进行全面的漏洞扫描。

#### 自己挖掘

通过手动分析和测试目标系统，以发现那些自动化扫描工具可能无法识别或漏报的潜在安全漏洞。这个过程需要深厚的网络安全知识和实践经验，以及对各种攻击技术和漏洞原理的深入理解。

**弱口令**

**定义**：弱口令是**指容易被猜测或破解的密码**，如“123456”、“password”等常用密码。
**挖掘方式**：通过**暴力破解**、**字典攻击**等方式尝试登录目标系统的账号，以发现是否存在弱口令问题。

**REC（远程命令执行漏洞和远程代码执行漏洞）**

**定义**：REC漏洞包括**远程命令执行**（RCE）和**远程代码执行**（RCE，尽管这里可能有些重复，但通常指不同层面），它们**允许攻击者远程执行系统命令或代码**。
**挖掘方式**：通过**输入特定格式的参数或利用应用程序的漏洞，尝试执行系统命令或代码**，观察是否成功执行。

**SQL 注入**

**定义**：SQL注入是**一种通过向Web应用程序的输入字段中插入恶意SQL代码，从而欺骗应用程序执行未授权的数据库操作**的安全漏洞。
**挖掘方式**：在应用程序的输入字段中**输入特殊字符**（如单引号、双引号、注释符号等），尝试**构造恶意的SQL查询**，观察是否成功**获取数据库信息或执行未授权操作**。

**XSS 跨站脚本攻击**

**定义**：XSS是一种**通过向网站注入恶意脚本代码，从而窃取用户敏感信息或对用户进行欺骗、木马攻击**等的网络安全漏洞。
**挖掘方式**：在网站的输入框、URL参数等位置**输入恶意脚本代码，观察是否能够在用户浏览器中成功执行**。

**CSRF(跨站请求伪造)**

**定义**：CSRF是一种网络攻击方式，攻击者**利用受害者的身份在受害者不知情的情况下执行未授权操作**。
**挖掘方式**：分析目标网站的敏感操作（如转账、修改密码等），**尝试构造恶意请求，诱导受害者执行**。

**SSRF(服务的请求伪造)**

**定义**：SSRF是一种**由攻击者构造的、由服务端发起请求**的安全漏洞，攻击者可以**通过该漏洞对服务器所在的内网、本地服务器等进行攻击**。
**挖掘方式**：通过向目标服务器发送包含内网IP地址或本地服务器资源的请求，观察服务器是否发起了相应的请求。

**文件上传/下载漏洞**

**定义**：文件上传、下载漏洞**允许攻击者上传或下载恶意文件，从而对服务器或用户造成危害**。
**挖掘方式**：尝试上传或下载文件，观察服务器是否对文件类型、大小等进行了有效的限制和验证。

### 2.4 漏洞验证

**对扫描出的漏洞进行验证，确保漏洞的真实性和可利用性**。验证方法包括自动化验证和手工验证，有时还需要搭建模拟环境进行试验验证。

- **自动化验证**：使用自动化工具对漏洞进行初步验证，确认漏洞的真实性和可利用性。
- **手工验证**：根据公开资源进行手工验证。尝试构建攻击场景，模拟黑客攻击过程。
- **实验验证**：在模拟环境中搭建目标系统的复制品，进行漏洞利用实验。验证漏洞利用的成功率和效果。

### 2.5 信息分析

分析收集到的信息和验证的漏洞，评估目标的整体安全状况，确定攻击的可能性和风险安全评估：

- **绕过防御机制**：分析并尝试绕过目标系统的WAF（Web应用防火墙）、防火墙等安全设备。
- **定制攻击路径**：根据收集到的信息，规划从外网到内网的攻击路径，或直接攻击目标系统。
- **绕过检测机制**：了解并尝试绕过代码审查、入侵检测系统等安全监控措施。
- **攻击代码**：编写或选择合适的攻击代码，对目标系统进行实际攻击，以评估其安全性和稳定性

